<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GENERATOR PROMPT AI by Sing Sareh</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Add a modern digital-like font if possible, or use a generic sans-serif -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Dark background */
            color: #e0e0e0; /* Light text */
            margin: 0;
            padding: 20px; /* Base padding */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }
        /* Responsive padding for body */
        @media (min-width: 640px) { /* sm breakpoint */
            body {
                padding: 24px; /* p-6 */
            }
        }
        @media (min-width: 768px) { /* md breakpoint */
            body {
                padding: 32px; /* p-8 */
            }
        }

        .container {
            background-color: #2a2a4a; /* Slightly lighter dark background for container */
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 1200px;
            padding: 30px;
            box-sizing: border-box;
        }
        /* Updated Glowing Title Styling */
        .app-title-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .app-title-main {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2rem; /* Base size for mobile */
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 0 10px #00bfff, 0 0 20px #00bfff, 0 0 30px #00bfff, 0 0 40px #00bfff;
            animation: glow 1.5s ease-in-out infinite alternate;
            display: block;
            line-height: 1.2;
        }
        /* Responsive font sizes for main title */
        @media (min-width: 640px) { /* sm breakpoint */
            .app-title-main {
                font-size: 2.8rem;
            }
        }
        @media (min-width: 768px) { /* md breakpoint */
            .app-title-main {
                font-size: 3.2rem; /* Slightly larger for desktop */
            }
        }

        .app-title-sub {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem; /* Base size for mobile */
            font-weight: 600;
            color: #ff9900; /* Contrasting color (orange/gold) */
            display: block;
            margin-top: 5px;
        }
        /* Responsive font sizes for sub-title */
        @media (min-width: 640px) { /* sm breakpoint */
            .app-title-sub {
                font-size: 1.1rem;
            }
        }
        @media (min-width: 768px) { /* md breakpoint */
            .app-title-sub {
                font-size: 1.2rem;
            }
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 5px #00bfff, 0 0 10px #00bfff;
            }
            to {
                text-shadow: 0 0 15px #00bfff, 0 0 25px #00bfff, 0 0 35px #00bfff;
            }
        }
        .tab-button {
            padding: 12px 25px;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            background-color: #3a3a5a;
            color: #a0a0c0;
            border: none;
        }
        .tab-button.active {
            background-color: #4a4a7a;
            color: #ffffff;
            box-shadow: inset 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        .tab-button:hover:not(.active) {
            background-color: #4a4a7a;
            color: #ffffff;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #c0c0e0;
        }
        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #5a5a8a;
            background-color: #3a3a5a;
            color: #e0e0e0;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #00bfff;
            box-shadow: 0 0 0 2px rgba(0, 191, 255, 0.5);
        }
        .button-primary {
            background-color: #00bfff;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 191, 255, 0.4);
        }
        .button-primary:hover {
            background-color: #009acd;
            transform: translateY(-2px);
        }
        .button-secondary {
            background-color: #5a5a8a;
            color: #e0e0e0;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        .button-secondary:hover {
            background-color: #6a6a9a;
            transform: translateY(-2px);
        }
        .button-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        .result-area {
            background-color: #1a1a2e;
            border-radius: 10px;
            padding: 20px;
            min-height: 150px;
            border: 1px solid #5a5a8a;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            word-wrap: break-word; /* Break long words */
            overflow-x: auto; /* Allow horizontal scrolling if content is too wide */
        }
        .additional-results-area { /* New style for the separate area */
            background-color: #1a1a2e;
            border-radius: 10px;
            padding: 20px;
            min-height: 50px; /* Smaller min-height for additional results */
            border: 1px solid #5a5a8a;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
            margin-top: 20px; /* Add some space above */
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #00bfff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Message Box Styling */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50; /* Green for success */
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.error {
            background-color: #f44336; /* Red for error */
        }
        .message-box.show {
            opacity: 1;
        }
        /* Gallery specific styles */
        .gallery-item {
            background-color: #3a3a5a;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #5a5a8a;
            word-wrap: break-word;
        }
        .gallery-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .gallery-item-header h5 {
            font-weight: 600;
            color: #ffffff;
        }
        .gallery-item-actions button {
            background-color: #00bfff;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease;
            margin-left: 8px;
        }
        .gallery-item-actions button.delete-btn {
            background-color: #f44336;
        }
        .gallery-item-actions button:hover {
            opacity: 0.9;
        }
        .gallery-item p {
            font-size: 0.9rem;
            color: #c0c0e0;
            margin-bottom: 5px;
        }
        .gallery-item .meta-info {
            font-size: 0.75rem;
            color: #888;
            margin-top: 10px;
            border-top: 1px solid #4a4a7a;
            padding-top: 5px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-5">
    <div class="container">
        <!-- Updated App Title Structure -->
        <div class="app-title-container">
            <span class="app-title-main">GENERATOR PROMPT AI</span>
            <span class="app-title-sub">by Sing Sareh</span>
        </div>
        <p class="text-center text-base sm:text-lg mb-8 text-gray-300">Isi bidang-bidang di bawah untuk membuat prompt yang sangat detail</p>

        <!-- User Status Message and Login Info Button -->
        <div class="flex flex-col sm:flex-row justify-center items-center gap-2 mb-4">
            <span class="text-center text-sm text-gray-500" id="user-status-message">
                Memuat status pengguna...
            </span>
            <button id="btn-google-auth" class="button-primary px-4 py-2 text-sm">Login dengan Google</button>
            <button id="btn-logout" class="button-secondary px-4 py-2 text-sm hidden">Logout</button>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-8 space-x-2">
            <button id="tab-gambar" class="tab-button active">🖼️ Gambar</button>
            <button id="tab-video-tunggal" class="tab-button">🎬 Video Tunggal</button>
            <button id="tab-sutradara" class="tab-button">🎥 Sutradara</button>
            <button id="tab-teks" class="tab-button">✍️ Teks</button>
            <button id="tab-galeri" class="tab-button">🗄️ Galeri</button>
        </div>

        <!-- Tab Content -->
        <div id="tab-content-gambar" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="input-group">
                    <label for="gaya-gambar">Gaya Gambar</label>
                    <input type="text" id="gaya-gambar" placeholder="Contoh: Fotorealistik, Animasi 3D, Seni Digital">
                </div>
                <div class="input-group">
                    <label for="kategori-gambar">Kategori Gambar</label>
                    <input type="text" id="kategori-gambar" placeholder="Contoh: Manusia/Potret, Alam/Lanskap, Teknologi">
                </div>
                <div class="input-group">
                    <label for="sudut-kamera">Sudut Kamera</label>
                    <input type="text" id="sudut-kamera" placeholder="Contoh: Low Angle, High Angle, Close-up">
                </div>
                <div class="input-group">
                    <label for="waktu-pencahayaan">Waktu/Pencahayaan</label>
                    <input type="text" id="waktu-pencahayaan" placeholder="Contoh: Golden Hour, Night Scene, Studio Lighting">
                </div>
                <div class="input-group md:col-span-2">
                    <label for="subjek-gambar">Subjek (Siapa/Apa?)</label>
                    <textarea id="subjek-gambar" rows="2" placeholder="Contoh: Seorang wanita muda, Robot futuristik, Pemandangan gunung"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="aksi-gambar">Aksi (Apa yang dilakukan/terjadi?)</label>
                    <textarea id="aksi-gambar" rows="2" placeholder="Contoh: Sedang membaca buku, Berjalan di hutan, Ledakan energi"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="pengaturan-gambar">Pengaturan (Di mana/Latar belakang?)</label>
                    <textarea id="pengaturan-gambar" rows="2" placeholder="Contoh: Di kafe yang ramai, Hutan belantara, Kota masa depan"></textarea>
                </div>
                <div class="input-group">
                    <label for="suasana-emosi-gambar">Suasana/Emosi Utama</label>
                    <input type="text" id="suasana-emosi-gambar" placeholder="Contoh: Tenang, Dramatis, Gembira">
                </div>
                <div class="input-group">
                    <label for="bahan-tekstur-gambar">Bahan/Tekstur (Opsional)</label>
                    <input type="text" id="bahan-tekstur-gambar" placeholder="Contoh: Kayu, Logam, Sutra, Air">
                </div>
                <div class="input-group">
                    <label for="ekspresi-emosi-gambar">Ekspresi/Emosi (Opsional)</label>
                    <input type="text" id="ekspresi-emosi-gambar" placeholder="Contoh: Senyum lebar, Wajah tegang, Mata berbinar">
                </div>
                <div class="input-group">
                    <label for="usia-era-gambar">Usia/Era (Opsional)</label>
                    <input type="text" id="usia-era-gambar" placeholder="Contoh: Abad Pertengahan, 1980-an, Masa depan">
                </div>
                <div class="input-group">
                    <label for="rasio-aspek-gambar">Rasio Aspek (Opsional)</label>
                    <input type="text" id="rasio-aspek-gambar" placeholder="Contoh: 16:9, 4:3, 1:1">
                </div>
                <div class="input-group">
                    <label for="resolusi-gambar">Resolusi (Opsional)</label>
                    <input type="text" id="resolusi-gambar" placeholder="Contoh: 4K, 8K, Ultra HD">
                </div>
                <div class="input-group md:col-span-2">
                    <label for="ide-tambahan-gambar">Ide Tambahan (Opsional)</label>
                    <textarea id="ide-tambahan-gambar" rows="2" placeholder="Detail tambahan atau instruksi khusus"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="prompt-negatif-gambar">Prompt Negatif (Apa yang tidak diinginkan)</label>
                    <textarea id="prompt-negatif-gambar" rows="2" placeholder="Contoh: Buruk, Distorsi, Teks, Tanda air"></textarea>
                </div>
            </div>
        </div>

        <div id="tab-content-video-tunggal" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="input-group md:col-span-2">
                    <label for="subjek-video">Subjek Video</label>
                    <textarea id="subjek-video" rows="2" placeholder="Contoh: Sebuah pesawat luar angkasa, Kota yang sibuk"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="karakter-utama-video">Karakter Utama (Opsional)</label>
                    <textarea id="karakter-utama-video" rows="2" placeholder="Contoh: Seorang detektif tua, Robot ceria"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="karakter-pendukung-video">Karakter Pendukung (Opsional)</label>
                    <textarea id="karakter-pendukung-video" rows="2" placeholder="Contoh: Asisten yang setia, Sekelompok alien"></textarea>
                </div>
                <!-- New: Jumlah Karakter -->
                <div class="input-group">
                    <label for="jumlah-karakter-video">Jumlah Karakter (untuk dialog)</label>
                    <input type="number" id="jumlah-karakter-video" min="0" value="0" placeholder="Contoh: 2">
                </div>
                <div class="input-group">
                    <label for="durasi-video">Durasi Video (detik)</label>
                    <input type="number" id="durasi-video" min="1" value="5" placeholder="Contoh: 5, 10, 30">
                </div>
                <!-- Dynamic Dialog Fields Container -->
                <div id="dialog-fields-container" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Dynamic dialog fields will be inserted here -->
                </div>

                <div class="input-group md:col-span-2">
                    <label for="aksi-video">Aksi Video</label>
                    <textarea id="aksi-video" rows="2" placeholder="Contoh: Melayang di luar angkasa, Lalu lintas bergerak cepat"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="pengaturan-video">Pengaturan Video</label>
                    <textarea id="pengaturan-video" rows="2" placeholder="Contoh: Di luar angkasa dengan latar belakang bumi, Jalanan perkotaan di malam hari"></textarea>
                </div>
                <div class="input-group">
                    <label for="suasana-emosi-video">Suasana/Emosi Video</label>
                    <input type="text" id="suasana-emosi-video" placeholder="Contoh: Inspiratif, Dinamis, Tenang">
                </div>
                <div class="input-group">
                    <label for="pergerakan-kamera">Pergerakan Kamera</label>
                    <select id="pergerakan-kamera">
                        <option value="">Pilih</option>
                        <option value="Pan">Pan (Geser Horizontal)</option>
                        <option value="Tilt">Tilt (Geser Vertikal)</option>
                        <option value="Zoom In">Zoom In</option>
                        <option value="Zoom Out">Zoom Out</option>
                        <option value="Dolly In">Dolly In (Maju ke Subjek)</option>
                        <option value="Dolly Out">Dolly Out (Mundur dari Subjek)</option>
                        <option value="Orbit">Orbit (Mengelilingi Subjek)</option>
                        <option value="Static">Static (Diam)</option>
                    </select>
                </div>
                <!-- Changed Gaya Video to dropdown -->
                <div class="input-group">
                    <label for="gaya-video">Gaya Video</label>
                    <select id="gaya-video">
                        <option value="">Pilih</option>
                        <option value="Cinematic">Cinematic</option>
                        <option value="Documentary">Documentary</option>
                        <option value="Vlog Style">Vlog Style</option>
                        <option value="Animation">Animation</option>
                        <option value="Stop Motion">Stop Motion</option>
                        <option value="Time-lapse">Time-lapse</option>
                        <option value="Hyperlapse">Hyperlapse</option>
                        <option value="Slow Motion">Slow Motion</option>
                        <option value="Action Cam">Action Cam</option>
                        <option value="Drone Footage">Drone Footage</option>
                        <option value="Surveillance Footage">Surveillance Footage</option>
                        <option value="Found Footage">Found Footage</option>
                        <option value="Music Video">Music Video</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Explainer Video">Explainer Video</option>
                        <option value="Tutorial">Tutorial</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="bahasa-dialog">Bahasa Dialog (Opsional)</label>
                    <input type="text" id="bahasa-dialog" placeholder="Contoh: Bahasa Inggris, Bahasa Indonesia">
                </div>
                <!-- New: Backsound and Efek Suara -->
                <div class="input-group md:col-span-2">
                    <label for="backsound-video">Backsound (Opsional)</label>
                    <textarea id="backsound-video" rows="2" placeholder="Contoh: Musik latar orkestra epik, Suara alam yang menenangkan"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="efek-suara-video">Efek Suara (Opsional)</label>
                    <textarea id="efek-suara-video" rows="2" placeholder="Contoh: Suara ledakan, Deru mesin, Langkah kaki"></textarea>
                </div>

                <div class="input-group md:col-span-2">
                    <label for="ide-tambahan-video">Ide Tambahan Video (Opsional)</label>
                    <textarea id="ide-tambahan-video" rows="2" placeholder="Detail tambahan atau instruksi khusus untuk video"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="prompt-negatif-video">Prompt Negatif Video (Opsional)</label>
                    <textarea id="prompt-negatif-video" rows="2" placeholder="Apa yang tidak diinginkan dalam video"></textarea>
                </div>
            </div>
        </div>

        <div id="tab-content-sutradara" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="input-group">
                    <label for="durasi-video-total-sutradara">Durasi Video Total (detik)</label>
                    <input type="number" id="durasi-video-total-sutradara" min="1" value="60" placeholder="Contoh: 60, 120">
                </div>
                <div class="input-group">
                    <label for="durasi-per-segmen-sutradara">Durasi Per Segmen (detik)</label>
                    <input type="number" id="durasi-per-segmen-sutradara" min="1" value="10" placeholder="Contoh: 10, 15">
                </div>
                <div class="input-group md:col-span-2">
                    <label for="gaya-video-sutradara">Gaya Video</label>
                    <select id="gaya-video-sutradara">
                        <option value="">Pilih</option>
                        <option value="Cinematic">Cinematic</option>
                        <option value="Documentary">Documentary</option>
                        <option value="Vlog Style">Vlog Style</option>
                        <option value="Animation">Animation</option>
                        <option value="Stop Motion">Stop Motion</option>
                        <option value="Time-lapse">Time-lapse</option>
                        <option value="Hyperlapse">Hyperlapse</option>
                        <option value="Slow Motion">Slow Motion</option>
                        <option value="Action Cam">Action Cam</option>
                        <option value="Drone Footage">Drone Footage</option>
                        <option value="Surveillance Footage">Surveillance Footage</option>
                        <option value="Found Footage">Found Footage</option>
                        <option value="Music Video">Music Video</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Explainer Video">Explainer Video</option>
                        <option value="Tutorial">Tutorial</option>
                    </select>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="subjek-utama-skenario">Subjek Utama Skenario</label>
                    <textarea id="subjek-utama-skenario" rows="2" placeholder="Contoh: Perjalanan seorang pahlawan, Evolusi teknologi"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="alur-cerita-singkat">Alur Cerita Singkat</label>
                    <textarea id="alur-cerita-singkat" rows="4" placeholder="Garis besar cerita atau narasi"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="ide-tambahan-skenario">Ide Tambahan Skenario (Opsional)</label>
                    <textarea id="ide-tambahan-skenario" rows="2" placeholder="Detail tambahan atau instruksi khusus untuk skenario"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="prompt-negatif-skenario">Prompt Negatif Skenario (Opsional)</label>
                    <textarea id="prompt-negatif-skenario" rows="2" placeholder="Apa yang tidak diinginkan dalam skenario"></textarea>
                </div>
            </div>
        </div>

        <!-- New: Tab Content for Teks -->
        <div id="tab-content-teks" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="input-group md:col-span-2">
                    <label for="topik-teks">Topik Teks</label>
                    <textarea id="topik-teks" rows="2" placeholder="Contoh: Sejarah penemuan roda, Manfaat meditasi"></textarea>
                </div>
                <div class="input-group">
                    <label for="gaya-teks">Gaya Teks</label>
                    <select id="gaya-teks">
                        <option value="">Pilih</option>
                        <option value="Formal">Formal</option>
                        <option value="Informal">Informal</option>
                        <option value="Kreatif">Kreatif</option>
                        <option value="Informatif">Informatif</option>
                        <option value="Persuasif">Persuasif</option>
                        <option value="Naratif">Naratif</option>
                        <option value="Deskriptif">Deskriptif</option>
                        <option value="Humor">Humor</option>
                        <option value="Teknis">Teknis</option>
                        <option value="Akademik">Akademik</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="audiens-target-teks">Audiens Target</label>
                    <input type="text" id="audiens-target-teks" placeholder="Contoh: Mahasiswa, Profesional, Anak-anak">
                </div>
                <div class="input-group">
                    <label for="tujuan-teks">Tujuan Teks</label>
                    <input type="text" id="tujuan-teks" placeholder="Contoh: Menjelaskan, Menghibur, Membujuk">
                </div>
                <div class="input-group">
                    <label for="panjang-teks">Panjang Teks</label>
                    <select id="panjang-teks">
                        <option value="">Pilih</option>
                        <option value="Pendek (1-2 paragraf)">Pendek (1-2 paragraf)</option>
                        <option value="Sedang (3-5 paragraf)">Sedang (3-5 paragraf)</option>
                        <option value="Panjang (>5 paragraf)">Panjang (>5 paragraf)</option>
                    </select>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="kata-kunci-utama-teks">Kata Kunci Utama</label>
                    <input type="text" id="kata-kunci-utama-teks" placeholder="Contoh: AI, etika, masa depan">
                </div>
                <div class="input-group md:col-span-2">
                    <label for="ide-tambahan-teks">Ide Tambahan Teks (Opsional)</label>
                    <textarea id="ide-tambahan-teks" rows="2" placeholder="Detail tambahan atau instruksi khusus untuk teks"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="prompt-negatif-teks">Prompt Negatif Teks (Opsional)</label>
                    <textarea id="prompt-negatif-teks" rows="2" placeholder="Apa yang tidak diinginkan dalam teks"></textarea>
                </div>
            </div>
        </div>

        <!-- Updated: Tab Content for Galeri -->
        <div id="tab-content-galeri" class="tab-content hidden">
            <h3 class="text-xl font-bold mb-4 text-gray-200 text-center">Galeri Prompt Tersimpan</h3>
            <p class="text-center text-gray-400 mb-6">Prompt yang Anda simpan akan muncul di sini. Anda dapat memuat atau menghapus prompt Anda sendiri.</p>
            <div id="gallery-loading-indicator" class="loading-spinner hidden"></div>
            <div id="gallery-content" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Saved prompts will be loaded here -->
            </div>
        </div>

        <!-- Main Control Buttons -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button id="btn-bersihkan" class="button-secondary">🖌️ Bersihkan</button>
            <button id="btn-acak" class="button-secondary">💡 Acak</button>
            <button id="btn-buat-manual" class="button-secondary">🚀 Buat Manual</button>
            <button id="btn-buat-ai" class="button-primary">✨ Buat dengan AI</button>
            <button id="btn-simpan-prompt" class="button-primary">💾 Simpan Prompt</button> <!-- New Save Button -->
        </div>

        <!-- Additional Feature Buttons (Gambar Tab Only) -->
        <div id="additional-features" class="flex flex-wrap justify-center gap-4 mb-8">
            <button id="btn-tingkatkan-prompt" class="button-secondary">✨ Tingkatkan Prompt</button>
            <button id="btn-sarankan-kata-kunci" class="button-secondary">✨ Sarankan Kata Kunci</button>
            <button id="btn-hasilkan-deskripsi" class="button-secondary">✨ Hasilkan Deskripsi</button>
            <button id="btn-buat-variasi-prompt" class="button-secondary">✨ Buat Variasi Prompt</button>
            <button id="btn-perbaiki-gramatika" class="button-secondary">✨ Perbaiki Gramatika/Ejaan</button>
            <button id="btn-sarankan-palet-warna" class="button-secondary">✨ Sarankan Palet Warna</button>
            <button id="btn-sarankan-konsep-terkait" class="button-secondary">✨ Sarankan Konsep Terkait</button>
        </div>

        <!-- Translation Dropdown -->
        <div class="flex justify-end mb-8">
            <div class="input-group w-48">
                <label for="terjemahan-bahasa">Terjemahkan Hasil ke</label>
                <select id="terjemahan-bahasa">
                    <option value="en">Inggris</option>
                    <option value="id">Indonesia</option>
                    <option value="es">Spanyol</option>
                    <option value="fr">Prancis</option>
                    <option value="de">Jerman</option>
                    <option value="ja">Jepang</option>
                    <option value="ko">Korea</option>
                    <option value="zh">Mandarin</option>
                </select>
            </div>
        </div>

        <!-- Result Area for Main Prompt -->
        <div class="result-area p-6 rounded-lg shadow-inner">
            <h3 class="text-xl font-bold mb-4 text-gray-200">Hasil Prompt Utama:</h3>
            <div id="loading-indicator-main" class="loading-spinner hidden"></div>
            <div id="result-content" class="text-gray-300">
                <!-- Generated main prompt will appear here -->
            </div>
        </div>

        <!-- New Result Area for Additional Features -->
        <div id="additional-results-area" class="additional-results-area p-6 rounded-lg shadow-inner hidden">
            <h3 class="text-xl font-bold mb-4 text-gray-200">Hasil Fitur Tambahan:</h3>
            <div id="loading-indicator-additional" class="loading-spinner hidden"></div>
            <div id="additional-content" class="text-gray-300">
                <!-- Results from additional features will appear here -->
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="message-box hidden"></div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // API Key for Gemini (empty string will be filled by Canvas runtime)
        const apiKey = "AIzaSyA8H2QWB4ToX3WQYrW3HjiCuMPeKlMrR74"; // Updated with provided API key

        // Firebase Initialization
        let app;
        let db;
        let auth;
        let currentUserId = null; // To store the authenticated user's ID
        let isLoggedInUser = false; // Flag to determine if user is "logged in" (non-anonymous)

        // DOM Elements (Moved to top of script for proper initialization order)
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const additionalFeaturesDiv = document.getElementById('additional-features');
        const resultDiv = document.getElementById('result-content'); // Main prompt area
        const additionalResultsArea = document.getElementById('additional-results-area'); // New: Additional features result area
        const additionalContentDiv = document.getElementById('additional-content'); // Content inside additional results area
        const loadingIndicatorMain = document.getElementById('loading-indicator-main'); // Loading for main prompt
        const loadingIndicatorAdditional = document.getElementById('loading-indicator-additional'); // Loading for additional features
        const translationDropdown = document.getElementById('terjemahan-bahasa');
        const messageBox = document.getElementById('message-box'); // Message box element
        const galleryContentDiv = document.getElementById('gallery-content'); // Gallery content area
        const galleryLoadingIndicator = document.getElementById('gallery-loading-indicator'); // Gallery loading spinner
        const btnGoogleAuth = document.getElementById('btn-google-auth'); // Google Login button
        const btnLogout = document.getElementById('btn-logout'); // Logout button
        const userStatusMessage = document.getElementById('user-status-message'); // User status message element


        // Function to update button states based on isLoggedInUser flag
        function updateButtonStates() {
            const btnBuatAI = document.getElementById('btn-buat-ai');
            const btnSimpanPrompt = document.getElementById('btn-simpan-prompt');
            const additionalFeatureButtons = document.querySelectorAll('#additional-features button');
            
            if (isLoggedInUser) {
                // User is logged in (non-anonymous)
                btnBuatAI.classList.remove('button-disabled');
                btnBuatAI.disabled = false;
                btnSimpanPrompt.classList.remove('button-disabled');
                btnSimpanPrompt.disabled = false;
                additionalFeatureButtons.forEach(button => {
                    button.classList.remove('button-disabled');
                    button.disabled = false;
                });
                userStatusMessage.textContent = `Anda masuk sebagai: ${auth.currentUser.displayName || currentUserId.substring(0, 8) + '...'}`;
                btnGoogleAuth.classList.add('hidden'); // Hide login button
                btnLogout.classList.remove('hidden'); // Show logout button
            } else {
                // User is anonymous or not authenticated
                btnBuatAI.classList.add('button-disabled');
                btnBuatAI.disabled = true;
                btnSimpanPrompt.classList.add('button-disabled');
                btnSimpanPrompt.disabled = true;
                additionalFeatureButtons.forEach(button => {
                    button.classList.add('button-disabled');
                    button.disabled = true;
                });
                userStatusMessage.textContent = `Anda masuk sebagai: ${currentUserId ? currentUserId.substring(0, 8) + '...' : 'Tamu'}`;
                btnGoogleAuth.classList.remove('hidden'); // Show login button
                btnLogout.classList.add('hidden'); // Hide logout button
            }
        }

        // Initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        // A user is considered "logged in" if they are not anonymous
                        isLoggedInUser = !user.isAnonymous;
                        console.log("Authenticated as:", currentUserId, "Is Anonymous:", user.isAnonymous, "Is Logged In (for AI):", isLoggedInUser);
                        updateButtonStates(); // Update button states based on new login status
                        loadGalleryPrompts(); // Load gallery after user is known
                    } else {
                        // No user is authenticated, attempt anonymous sign-in
                        isLoggedInUser = false;
                        currentUserId = null; // Clear userId if truly unauthenticated
                        updateButtonStates(); // Update button states to disabled
                        try {
                            await signInAnonymously(auth);
                        } catch (anonError) {
                            console.error("Error signing in anonymously:", anonError);
                            showMessage("Error: Gagal masuk secara anonim. Fitur penyimpanan mungkin tidak berfungsi.", true);
                        }
                    }
                });

                // Attempt to sign in with custom token first if available (Canvas specific)
                // This is typically for the developer's privileged access
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (tokenError) {
                        console.warn("Custom auth token failed, attempting anonymous sign-in (if not already handled):", tokenError);
                        // onAuthStateChanged will handle anonymous sign-in if user is null after this.
                    }
                } else {
                    // If no custom token, ensure initial state disables AI features
                    // and onAuthStateChanged will handle anonymous sign-in.
                    updateButtonStates();
                }

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage("Error: Gagal menginisialisasi Firebase. Fitur penyimpanan tidak tersedia.", true);
            }
        }

        initializeFirebase();


        // Input fields for Gambar tab
        const gambarInputs = {
            gaya: document.getElementById('gaya-gambar'),
            kategori: document.getElementById('kategori-gambar'),
            sudutKamera: document.getElementById('sudut-kamera'),
            waktuPencahayaan: document.getElementById('waktu-pencahayaan'),
            subjek: document.getElementById('subjek-gambar'),
            aksi: document.getElementById('aksi-gambar'),
            pengaturan: document.getElementById('pengaturan-gambar'),
            suasanaEmosi: document.getElementById('suasana-emosi-gambar'),
            bahanTekstur: document.getElementById('bahan-tekstur-gambar'),
            ekspresiEmosi: document.getElementById('ekspresi-emosi-gambar'),
            usiaEra: document.getElementById('usia-era-gambar'),
            rasioAspek: document.getElementById('rasio-aspek-gambar'),
            resolusi: document.getElementById('resolusi-gambar'),
            ideTambahan: document.getElementById('ide-tambahan-gambar'),
            promptNegatif: document.getElementById('prompt-negatif-gambar')
        };

        // Input fields for Video Tunggal tab
        const videoInputs = {
            subjek: document.getElementById('subjek-video'),
            karakterUtama: document.getElementById('karakter-utama-video'),
            karakterPendukung: document.getElementById('karakter-pendukung-video'),
            jumlahKarakter: document.getElementById('jumlah-karakter-video'),
            aksi: document.getElementById('aksi-video'),
            pengaturan: document.getElementById('pengaturan-video'),
            suasanaEmosi: document.getElementById('suasana-emosi-video'),
            durasi: document.getElementById('durasi-video'),
            pergerakanKamera: document.getElementById('pergerakan-kamera'),
            gayaVideo: document.getElementById('gaya-video'), // Now a select element
            bahasaDialog: document.getElementById('bahasa-dialog'),
            backsound: document.getElementById('backsound-video'), // New backsound input
            efekSuara: document.getElementById('efek-suara-video'), // New sound effects input
            ideTambahan: document.getElementById('ide-tambahan-video'),
            promptNegatif: document.getElementById('prompt-negatif-video')
        };

        // Input fields for Sutradara tab
        const sutradaraInputs = {
            durasiVideoTotal: document.getElementById('durasi-video-total-sutradara'),
            durasiPerSegmen: document.getElementById('durasi-per-segmen-sutradara'),
            gayaVideoSutradara: document.getElementById('gaya-video-sutradara'),
            subjekUtamaSkenario: document.getElementById('subjek-utama-skenario'),
            alurCeritaSingkat: document.getElementById('alur-cerita-singkat'),
            ideTambahanSkenario: document.getElementById('ide-tambahan-skenario'),
            promptNegatifSkenario: document.getElementById('prompt-negatif-skenario')
        };

        // Input fields for Teks tab
        const textInputs = {
            topikTeks: document.getElementById('topik-teks'),
            gayaTeks: document.getElementById('gaya-teks'),
            audiensTargetTeks: document.getElementById('audiens-target-teks'),
            tujuanTeks: document.getElementById('tujuan-teks'),
            panjangTeks: document.getElementById('panjang-teks'),
            kataKunciUtamaTeks: document.getElementById('kata-kunci-utama-teks'),
            ideTambahanTeks: document.getElementById('ide-tambahan-teks'),
            promptNegatifTeks: document.getElementById('prompt-negatif-teks')
        };

        // Container for dynamic dialog fields (Video Tunggal tab)
        const dialogFieldsContainer = document.getElementById('dialog-fields-container');

        // Store the last generated English prompt for additional features and translation
        let lastEnglishPrompt = '';
        let lastIndonesianPrompt = '';

        // Function to show/hide loading spinner for specific area
        function showLoading(show, area = 'main') {
            if (area === 'main') {
                if (show) {
                    loadingIndicatorMain.classList.remove('hidden');
                    resultDiv.innerHTML = ''; // Clear previous results
                } else {
                    loadingIndicatorMain.classList.add('hidden');
                }
            } else if (area === 'additional') {
                if (show) {
                    loadingIndicatorAdditional.classList.remove('hidden');
                    additionalContentDiv.innerHTML = ''; // Clear previous additional results
                    additionalResultsArea.classList.remove('hidden'); // Ensure additional area is visible
                } else {
                    loadingIndicatorAdditional.classList.add('hidden');
                }
            } else if (area === 'gallery') {
                if (show) {
                    galleryLoadingIndicator.classList.remove('hidden');
                    galleryContentDiv.innerHTML = '';
                } else {
                    galleryLoadingIndicator.classList.add('hidden');
                }
            }
        }

        // Function to display messages (success/error)
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; // Reset classes
            if (isError) {
                messageBox.classList.add('error');
            } else {
                messageBox.classList.remove('error');
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        // Function to call Gemini API
        async function callGeminiAPI(prompt, schema = null, targetArea = 'main') {
            if (!isLoggedInUser) {
                showMessage("Fitur AI hanya tersedia untuk pengguna yang login. Silakan gunakan 'Buat Manual'.", true);
                return "Error: Fitur AI tidak tersedia.";
            }

            showLoading(true, targetArea);
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (schema) {
                        return JSON.parse(text); // Return parsed JSON for structured responses
                    }
                    return text; // Return plain text for unstructured responses
                } else {
                    console.error("Unexpected API response structure:", result);
                    return "Error: Tidak dapat menghasilkan respons dari AI. Coba lagi.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "Error: Terjadi kesalahan saat menghubungi AI. Periksa koneksi Anda atau coba lagi.";
            } finally {
                showLoading(false, targetArea);
            }
        }

        // Function to dynamically generate dialog fields based on 'Jumlah Karakter'
        function generateDialogFields(numCharacters) {
            dialogFieldsContainer.innerHTML = ''; // Clear existing fields
            // Remove old dynamic dialog elements from videoInputs
            for (const key in videoInputs) {
                if (key.startsWith('dialogKarakter')) {
                    delete videoInputs[key];
                }
            }

            if (numCharacters > 0) {
                for (let i = 1; i <= numCharacters; i++) {
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'input-group md:col-span-2'; // Each dialog field takes full width
                    inputGroup.innerHTML = `
                        <label for="dialog-karakter-${i}">Dialog Karakter ${i} (Opsional)</label>
                        <textarea id="dialog-karakter-${i}" rows="2" placeholder="Dialog untuk karakter ${i}"></textarea>
                    `;
                    dialogFieldsContainer.appendChild(inputGroup);
                    // Add the newly created textarea to theInputs object
                    videoInputs[`dialogKarakter${i}`] = document.getElementById(`dialog-karakter-${i}`);
                }
            }
        }

        // Event listener for 'Jumlah Karakter' input
        videoInputs.jumlahKarakter.addEventListener('input', (event) => {
            const num = parseInt(event.target.value);
            if (!isNaN(num) && num >= 0) {
                generateDialogFields(num);
            } else {
                generateDialogFields(0); // Clear fields if input is invalid
            }
        });


        // Function to switch tabs
        function switchTab(tabId) {
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });

            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`tab-content-${tabId}`).classList.remove('hidden');

            // Show/hide additional features based on tab
            // Additional features are only for 'gambar' tab
            if (tabId === 'gambar') {
                additionalFeaturesDiv.classList.remove('hidden');
            } else {
                additionalFeaturesDiv.classList.add('hidden');
            }

            // Clear all results and last prompts on tab switch
            resultDiv.innerHTML = '';
            additionalContentDiv.innerHTML = ''; // Clear additional results area
            additionalResultsArea.classList.add('hidden'); // Hide additional results area
            lastEnglishPrompt = '';
            lastIndonesianPrompt = '';

            // If switching to video tab, ensure dialog fields are generated based on current number
            if (tabId === 'video-tunggal') {
                const num = parseInt(videoInputs.jumlahKarakter.value);
                if (!isNaN(num) && num >= 0) {
                    generateDialogFields(num);
                }
            }

            // If switching to gallery tab, load prompts
            if (tabId === 'galeri') {
                loadGalleryPrompts();
            }
        }

        // Event listeners for tab buttons
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.id.replace('tab-', '');
                switchTab(tabId);
            });
        });

        // Initialize with Gambar tab active
        switchTab('gambar');

        // Function to clear all input fields for the active tab
        function clearInputs() {
            const activeTabContent = document.querySelector('.tab-content:not(.hidden)');
            if (activeTabContent) {
                activeTabContent.querySelectorAll('input, textarea, select').forEach(input => {
                    if (input.type === 'number') {
                        input.value = input.min || ''; // Reset number inputs to min or empty
                    } else if (input.tagName === 'SELECT') {
                        input.value = ''; // Reset select to default empty option
                    } else {
                        input.value = '';
                    }
                });
            }
            // Specifically clear dynamic dialog fields and reset count for video tab
            if (activeTabContent.id === 'tab-content-video-tunggal') {
                videoInputs.jumlahKarakter.value = '0';
                generateDialogFields(0); // Clear dynamic fields
            }
            resultDiv.innerHTML = ''; // Clear main result area
            additionalContentDiv.innerHTML = ''; // Clear additional results area
            additionalResultsArea.classList.add('hidden'); // Hide additional results area
            lastEnglishPrompt = '';
            lastIndonesianPrompt = '';
        }

        // Function to populate inputs with random/generic values (simple placeholder)
        function randomizeInputs() {
            const activeTabContent = document.querySelector('.tab-content:not(.hidden)');
            if (activeTabContent.id === 'tab-content-gambar') {
                gambarInputs.gaya.value = 'Seni Digital';
                gambarInputs.kategori.value = 'Alam/Lanskap';
                gambarInputs.sudutKamera.value = 'Wide Angle';
                gambarInputs.waktuPencahayaan.value = 'Siang Hari';
                gambarInputs.subjek.value = 'Pohon besar dengan akar yang menjalar';
                gambarInputs.aksi.value = 'Berdiri tegak di tengah padang rumput';
                gambarInputs.pengaturan.value = 'Latar belakang pegunungan berkabut';
                gambarInputs.suasanaEmosi.value = 'Tenang dan megah';
                gambarInputs.rasioAspek.value = '16:9';
                gambarInputs.promptNegatif.value = 'Buruk, Distorsi';
            } else if (activeTabContent.id === 'tab-content-video-tunggal') {
                videoInputs.subjek.value = 'Gelombang laut';
                videoInputs.karakterUtama.value = 'Seekor burung camar';
                videoInputs.karakterPendukung.value = 'Beberapa kepiting kecil';
                videoInputs.jumlahKarakter.value = '2'; // Set to 2 characters for random
                generateDialogFields(2); // Generate 2 dialog fields
                // Assign example dialogues to the dynamically created fields
                if (videoInputs.dialogKarakter1) videoInputs.dialogKarakter1.value = 'Karakter 1: Halo, apa kabar?';
                if (videoInputs.dialogKarakter2) videoInputs.dialogKarakter2.value = 'Karakter 2: Baik, terima kasih!';
                videoInputs.aksi.value = 'Berdebur ke pantai';
                videoInputs.pengaturan.value = 'Pemandangan pantai yang indah';
                videoInputs.suasanaEmosi.value = 'Damai dan menenangkan';
                videoInputs.durasi.value = '10';
                videoInputs.pergerakanKamera.value = 'Pan';
                videoInputs.gayaVideo.value = 'Cinematic'; // Set dropdown value
                videoInputs.bahasaDialog.value = 'Bahasa Indonesia';
                videoInputs.backsound.value = 'Musik latar ombak laut'; // Example backsound
                videoInputs.efekSuara.value = 'Suara burung camar, Deburan ombak'; // Example sound effects
                videoInputs.promptNegatif.value = 'Goyangan kamera, Orang-orang';
            } else if (activeTabContent.id === 'tab-content-sutradara') {
                sutradaraInputs.durasiVideoTotal.value = '20'; // Example: 20 seconds total
                sutradaraInputs.durasiPerSegmen.value = '8'; // Example: 8 seconds per segment
                sutradaraInputs.gayaVideoSutradara.value = 'Documentary';
                sutradaraInputs.subjekUtamaSkenario.value = 'Perjalanan penemuan di hutan belantara Amazon';
                sutradaraInputs.alurCeritaSingkat.value = 'Seorang penjelajah memulai perjalanan untuk menemukan spesies tumbuhan langka. Dia menghadapi tantangan alam dan bertemu suku asli, belajar tentang kebijaksanaan kuno.';
                sutradaraInputs.ideTambahanSkenario.value = 'Gunakan drone footage untuk pemandangan luas. Fokus pada detail flora dan fauna.';
                sutradaraInputs.promptNegatifSkenario.value = 'Kekerasan, Konflik, Perusakan lingkungan';
            } else if (activeTabContent.id === 'tab-content-teks') {
                textInputs.topikTeks.value = 'Manfaat AI dalam kehidupan sehari-hari';
                textInputs.gayaTeks.value = 'Informatif';
                textInputs.audiensTargetTeks.value = 'Masyarakat umum';
                textInputs.tujuanTeks.value = 'Memberikan pemahaman dasar';
                textInputs.panjangTeks.value = 'Sedang (3-5 paragraf)';
                textInputs.kataKunciUtamaTeks.value = 'AI, teknologi, manfaat, kehidupan sehari-hari';
                textInputs.ideTambahanTeks.value = 'Sertakan contoh konkret dan mudah dipahami.';
                textInputs.promptNegatifTeks.value = 'Jargon teknis yang rumit, nada yang terlalu formal';
            }
            resultDiv.innerHTML = ''; // Clear main result area
            additionalContentDiv.innerHTML = ''; // Clear additional results area
            additionalResultsArea.classList.add('hidden'); // Hide additional results area
            lastEnglishPrompt = '';
            lastIndonesianPrompt = '';
        }

        // Event listener for Bersihkan button
        document.getElementById('btn-bersihkan').addEventListener('click', clearInputs);

        // Event listener for Acak button
        document.getElementById('btn-acak').addEventListener('click', randomizeInputs);

        // Event listener for Buat Manual button
        document.getElementById('btn-buat-manual').addEventListener('click', () => {
            // For "Buat Manual", we just concatenate the current input values
            const activeTabContent = document.querySelector('.tab-content:not(.hidden)');
            let manualPrompt = '';

            if (activeTabContent.id === 'tab-content-gambar') {
                manualPrompt = Object.keys(gambarInputs).map(key => {
                    const value = gambarInputs[key].value.trim();
                    const label = gambarInputs[key].previousElementSibling.textContent.replace('(Opsional)', '').trim();
                    return value ? `${label}: ${value}` : '';
                }).filter(Boolean).join('\n');
            } else if (activeTabContent.id === 'tab-content-video-tunggal') {
                const params = [];
                for (const key of ['subjek', 'karakterUtama', 'karakterPendukung', 'aksi', 'pengaturan', 'suasanaEmosi', 'durasi', 'pergerakanKamera', 'gayaVideo', 'bahasaDialog', 'backsound', 'efekSuara', 'ideTambahan', 'promptNegatif']) {
                    const inputElement = videoInputs[key];
                    if (inputElement && inputElement.value.trim()) {
                        let label = inputElement.previousElementSibling.textContent.replace('(Opsional)', '').trim();
                        params.push(`${label}: ${inputElement.value.trim()}`);
                    }
                }
                const numCharacters = parseInt(videoInputs.jumlahKarakter.value);
                if (!isNaN(numCharacters) && numCharacters > 0) {
                    let dialogs = [];
                    for (let i = 1; i <= numCharacters; i++) {
                        const dialogInput = videoInputs[`dialogKarakter${i}`];
                        if (dialogInput && dialogInput.value.trim()) {
                            dialogs.push(`Karakter ${i}: "${dialogInput.value.trim()}"`);
                        }
                    }
                    if (dialogs.length > 0) {
                        params.push(`Dialog: ${dialogs.join(' | ')}`);
                    }
                }
                manualPrompt = params.filter(Boolean).join('\n');
            } else if (activeTabContent.id === 'tab-content-sutradara') {
                manualPrompt = Object.keys(sutradaraInputs).map(key => {
                    const value = sutradaraInputs[key].value.trim();
                    const label = sutradaraInputs[key].previousElementSibling.textContent.replace('(Opsional)', '').trim();
                    return value ? `${label}: ${value}` : '';
                }).filter(Boolean).join('\n');
                manualPrompt = `Skenario Video Manual:\n${manualPrompt}`;
            } else if (activeTabContent.id === 'tab-content-teks') {
                manualPrompt = Object.keys(textInputs).map(key => {
                    const value = textInputs[key].value.trim();
                    const label = textInputs[key].previousElementSibling.textContent.replace('(Opsional)', '').trim();
                    return value ? `${label}: ${value}` : '';
                }).filter(Boolean).join('\n');
                manualPrompt = `Teks Manual:\n${manualPrompt}`;
            } else {
                manualPrompt = "Tidak ada input yang terdeteksi untuk tab ini.";
            }

            resultDiv.innerHTML = `
                <h4 class="text-lg font-semibold text-gray-100 mb-2">Prompt Manual:</h4>
                <textarea id="manual-prompt-output" class="w-full p-3 rounded-lg border border-gray-600 bg-gray-700 text-gray-200" rows="10" readonly>${manualPrompt}</textarea>
            `;
            additionalContentDiv.innerHTML = ''; // Clear additional results area
            additionalResultsArea.classList.add('hidden'); // Hide additional results area
            lastEnglishPrompt = manualPrompt; // Store manual prompt for potential translation
            lastIndonesianPrompt = manualPrompt; // Assuming manual input is in Indonesian
        });


        // Event listener for Buat dengan AI button
        document.getElementById('btn-buat-ai').addEventListener('click', async () => {
            // Check if AI features are enabled for the current user
            if (!isLoggedInUser) {
                showMessage("Fitur AI hanya tersedia untuk pengguna yang login. Silakan gunakan 'Buat Manual'.", true);
                return;
            }

            const activeTabContent = document.querySelector('.tab-content:not(.hidden)');
            let promptText = '';
            let schema = null; // Default schema for single prompt output

            // Clear additional results area when generating main prompt
            additionalContentDiv.innerHTML = '';
            additionalResultsArea.classList.add('hidden');

            if (activeTabContent.id === 'tab-content-gambar') {
                schema = {
                    type: "OBJECT",
                    properties: {
                        english_prompt: { type: "STRING" },
                        indonesian_prompt: { type: "STRING" }
                    },
                    required: ["english_prompt", "indonesian_prompt"]
                };

                const params = Object.keys(gambarInputs).map(key => {
                    const value = gambarInputs[key].value.trim();
                    const label = gambarInputs[key].previousElementSibling.textContent.replace('(Opsional)', '').trim();
                    return value ? `${label}: ${value}` : '';
                }).filter(Boolean).join('\n');

                promptText = `Buat prompt gambar detail dalam bahasa Inggris dan terjemahannya dalam bahasa Indonesia berdasarkan parameter berikut:\n${params}\nFormat output JSON dengan kunci 'english_prompt' dan 'indonesian_prompt'.`;

            } else if (activeTabContent.id === 'tab-content-video-tunggal') {
                schema = {
                    type: "OBJECT",
                    properties: {
                        english_prompt: { type: "STRING" },
                        indonesian_prompt: { type: "STRING" }
                    },
                    required: ["english_prompt", "indonesian_prompt"]
                };

                const params = [];
                // Collect static video inputs
                for (const key of ['subjek', 'karakterUtama', 'karakterPendukung', 'aksi', 'pengaturan', 'suasanaEmosi', 'durasi', 'pergerakanKamera', 'gayaVideo', 'bahasaDialog', 'backsound', 'efekSuara', 'ideTambahan', 'promptNegatif']) {
                    const inputElement = videoInputs[key];
                    if (inputElement && inputElement.value.trim()) {
                        let label = inputElement.previousElementSibling.textContent.replace('(Opsional)', '').trim();
                        params.push(`${label}: ${inputElement.value.trim()}`);
                    }
                }

                // Collect dynamic dialog inputs
                const numCharacters = parseInt(videoInputs.jumlahKarakter.value);
                if (!isNaN(numCharacters) && numCharacters > 0) {
                    let dialogs = [];
                    for (let i = 1; i <= numCharacters; i++) {
                        const dialogInput = videoInputs[`dialogKarakter${i}`];
                        if (dialogInput && dialogInput.value.trim()) {
                            dialogs.push(`Karakter ${i}: "${dialogInput.value.trim()}"`);
                        }
                    }
                    if (dialogs.length > 0) {
                        params.push(`Dialog: ${dialogs.join(' | ')}`); // Join dialogues with a clear separator
                    }
                }

                promptText = `Buat prompt video detail dalam bahasa Inggris dan terjemahannya dalam bahasa Indonesia berdasarkan parameter berikut:\n${params.filter(Boolean).join('\n')}\nPastikan dialog setiap karakter jelas terpisah. Format output JSON dengan kunci 'english_prompt' dan 'indonesian_prompt'.`;
            } else if (activeTabContent.id === 'tab-content-sutradara') {
                const totalDuration = parseInt(sutradaraInputs.durasiVideoTotal.value);
                const segmentDuration = parseInt(sutradaraInputs.durasiPerSegmen.value);

                if (isNaN(totalDuration) || totalDuration <= 0 || isNaN(segmentDuration) || segmentDuration <= 0) {
                    resultDiv.innerHTML = '<p class="text-red-400">Error: Durasi Video Total dan Durasi Per Segmen harus angka positif.</p>';
                    return;
                }

                const numSegments = Math.ceil(totalDuration / segmentDuration);

                schema = {
                    type: "OBJECT",
                    properties: {
                        segments: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    segment_number: { type: "NUMBER" },
                                    english_prompt: { type: "STRING" },
                                    indonesian_prompt: { type: "STRING" }
                                },
                                required: ["segment_number", "english_prompt", "indonesian_prompt"]
                            }
                        }
                    },
                    required: ["segments"]
                };

                const params = Object.keys(sutradaraInputs).map(key => {
                    const value = sutradaraInputs[key].value.trim();
                    const label = sutradaraInputs[key].previousElementSibling.textContent.replace('(Opsional)', '').trim();
                    return value ? `${label}: ${value}` : '';
                }).filter(Boolean).join('\n');

                promptText = `Buat skenario video yang terbagi menjadi ${numSegments} segmen, dengan setiap segmen berdurasi sekitar ${segmentDuration} detik, berdasarkan total durasi ${totalDuration} detik.
                Parameter umum untuk skenario:
                ${params}
                Untuk setiap segmen, berikan prompt gambar/video detail dalam bahasa Inggris dan terjemahannya dalam bahasa Indonesia.
                **Sangat penting:** Pastikan kontinuitas karakter, tema, suasana, dan alur cerita terjaga dengan mulus dari satu segmen ke segmen berikutnya. Karakter harus konsisten dalam penampilan dan perilaku. Tema dan suasana harus berkembang secara logis.
                Format output JSON dengan kunci 'segments' yang berisi array objek, setiap objek memiliki 'segment_number', 'english_prompt', dan 'indonesian_prompt'.`;
            } else if (activeTabContent.id === 'tab-content-teks') {
                schema = {
                    type: "OBJECT",
                    properties: {
                        english_text: { type: "STRING" },
                        indonesian_text: { type: "STRING" }
                    },
                    required: ["english_text", "indonesian_text"]
                };

                const params = Object.keys(textInputs).map(key => {
                    const value = textInputs[key].value.trim();
                    const label = textInputs[key].previousElementSibling.textContent.replace('(Opsional)', '').trim();
                    return value ? `${label}: ${value}` : '';
                }).filter(Boolean).join('\n');

                promptText = `Buat teks detail dalam bahasa Inggris dan terjemahannya dalam bahasa Indonesia berdasarkan parameter berikut:\n${params}\nFormat output JSON dengan kunci 'english_text' dan 'indonesian_text'.`;
            }
            else {
                resultDiv.innerHTML = '<p class="text-red-400">Fungsionalitas AI belum tersedia untuk tab ini.</p>';
                return;
            }

            const response = await callGeminiAPI(promptText, schema, 'main'); // Specify 'main' area for loading

            if (activeTabContent.id === 'tab-content-sutradara') {
                if (typeof response === 'object' && response.segments && Array.isArray(response.segments)) {
                    let outputHtml = '<h4 class="text-xl font-bold mb-4 text-gray-200">Skenario Video per Segmen:</h4>';
                    response.segments.forEach(segment => {
                        outputHtml += `<div class="mb-6 p-4 rounded-lg bg-gray-800 border border-gray-700">
                                        <h5 class="text-md font-semibold text-gray-200 mb-2">Segmen ${segment.segment_number}:</h5>
                                        <p class="mb-2"><strong>English:</strong> ${segment.english_prompt}</p>
                                        <p><strong>Indonesia:</strong> ${segment.indonesian_prompt}</p>
                                      </div>`;
                    });
                    resultDiv.innerHTML = outputHtml;
                    // For Sutradara, we don't store lastEnglishPrompt in the same way as it's multiple prompts
                    lastEnglishPrompt = '';
                    lastIndonesianPrompt = '';
                } else {
                    resultDiv.innerHTML = `<p class="text-red-400">Error: Struktur respons skenario tidak sesuai.</p><p>${JSON.stringify(response)}</p>`;
                }
            } else if (activeTabContent.id === 'tab-content-teks') {
                if (typeof response === 'object' && response.english_text && response.indonesian_text) {
                    lastEnglishPrompt = response.english_text; // Store generated text as last English prompt for translation
                    lastIndonesianPrompt = response.indonesian_text;
                    resultDiv.innerHTML = `
                        <h4 class="text-lg font-semibold text-gray-100 mb-2">Teks Bahasa Inggris:</h4>
                        <p class="mb-4">${lastEnglishPrompt}</p>
                        <h4 class="text-lg font-semibold text-gray-100 mb-2">Teks Bahasa Indonesia:</h4>
                        <p>${lastIndonesianPrompt}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="text-red-400">${response}</p>`;
                }
            }
            else { // For Gambar and Video Tunggal
                if (typeof response === 'object' && response.english_prompt && response.indonesian_prompt) {
                    lastEnglishPrompt = response.english_prompt;
                    lastIndonesianPrompt = response.indonesian_prompt;
                    resultDiv.innerHTML = `
                        <h4 class="text-lg font-semibold text-gray-100 mb-2">Prompt Bahasa Inggris:</h4>
                        <p class="mb-4">${lastEnglishPrompt}</p>
                        <h4 class="text-lg font-semibold text-gray-100 mb-2">Prompt Bahasa Indonesia:</h4>
                        <p>${lastIndonesianPrompt}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="text-red-400">${response}</p>`;
                }
            }
        });

        // Function to handle additional feature buttons
        async function handleAdditionalFeature(feature) {
            // Check if AI features are enabled for the current user
            if (!isLoggedInUser) {
                additionalContentDiv.innerHTML = "<p class='text-yellow-400'>Fitur AI hanya tersedia untuk pengguna yang login. Silakan gunakan 'Buat Manual'.</p>";
                additionalResultsArea.classList.remove('hidden');
                return;
            }

            if (!lastEnglishPrompt) {
                additionalContentDiv.innerHTML = '<p class="text-yellow-400">Silakan buat prompt utama terlebih dahulu menggunakan "Buat dengan AI".</p>';
                additionalResultsArea.classList.remove('hidden'); // Show the area even with a warning
                return;
            }

            let promptText = '';
            let schema = null;
            let displayTitle = '';
            let newContentHtml = '';

            // Clear the additional results area before generating new content for it
            additionalContentDiv.innerHTML = '';
            additionalResultsArea.classList.remove('hidden'); // Ensure it's visible

            switch (feature) {
                case 'tingkatkan-prompt':
                    displayTitle = 'Prompt yang Ditingkatkan:';
                    schema = {
                        type: "OBJECT",
                        properties: {
                            improved_english_prompt: { type: "STRING" },
                            improved_indonesian_prompt: { type: "STRING" }
                        },
                        required: ["improved_english_prompt", "improved_indonesian_prompt"]
                    };
                    promptText = `Tingkatkan prompt gambar berikut ini agar lebih detail, artistik, dan siap untuk model AI generatif. Berikan versi yang ditingkatkan dalam bahasa Inggris dan terjemahannya dalam bahasa Indonesia.
                    Prompt asli: ${lastEnglishPrompt}
                    Format output JSON dengan kunci 'improved_english_prompt' dan 'improved_indonesian_prompt'.`;
                    break;
                case 'sarankan-kata-kunci':
                    displayTitle = 'Saran Kata Kunci:';
                    schema = { // Define schema for keywords
                        type: "OBJECT",
                        properties: {
                            keywords: {
                                type: "ARRAY",
                                items: { type: "STRING" }
                            }
                        },
                        required: ["keywords"]
                    };
                    promptText = `Saran 10-15 kata kunci relevan untuk prompt gambar berikut ini, cocok untuk SEO di platform stok gambar. Berikan dalam format JSON dengan kunci 'keywords' yang berisi array string.
                    Prompt: ${lastEnglishPrompt}`;
                    break;
                case 'hasilkan-deskripsi':
                    displayTitle = 'Deskripsi Gambar:';
                    schema = {
                        type: "OBJECT",
                        properties: {
                            english_description: { type: "STRING" },
                            indonesian_description: { type: "STRING" }
                        },
                        required: ["english_description", "indonesian_description"]
                    };
                    promptText = `Buat deskripsi gambar yang ringkas dan menarik (sekitar 2-3 kalimat) untuk prompt berikut ini, cocok untuk platform stok gambar. Berikan dalam bahasa Inggris dan terjemahannya dalam bahasa Indonesia.
                    Prompt: ${lastEnglishPrompt}
                    Format output JSON dengan kunci 'english_description' dan 'indonesian_description'.`;
                    break;
                case 'buat-variasi-prompt':
                    displayTitle = 'Variasi Prompt:';
                    schema = {
                        type: "OBJECT",
                        properties: {
                            variations: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        english_variation: { type: "STRING" },
                                        indonesian_variation: { type: "STRING" }
                                    },
                                    required: ["english_variation", "indonesian_variation"]
                                }
                            }
                        },
                        required: ["variations"]
                    };
                    promptText = `Buat 3 variasi prompt gambar yang berbeda dari prompt berikut ini, masing-masing dalam bahasa Inggris dan terjemahannya dalam bahasa Indonesia.
                    Prompt: ${lastEnglishPrompt}
                    Format output JSON dengan kunci 'variations' yang berisi array objek, setiap objek memiliki kunci 'english_variation' dan 'indonesian_variation'.`;
                    break;
                case 'perbaiki-gramatika':
                    displayTitle = 'Prompt Setelah Koreksi:';
                    schema = {
                        type: "OBJECT",
                        properties: {
                            corrected_english_prompt: { type: "STRING" },
                            corrected_indonesian_prompt: { type: "STRING" }
                        },
                        required: ["corrected_english_prompt", "corrected_indonesian_prompt"]
                    };
                    promptText = `Perbaiki tata bahasa dan ejaan pada prompt berikut ini. Berikan versi yang sudah diperbaiki dalam bahasa Inggris dan terjemahannya dalam bahasa Indonesia.
                    Prompt: ${lastEnglishPrompt}
                    Format output JSON dengan kunci 'corrected_english_prompt' dan 'corrected_indonesian_prompt'.`;
                    break;
                case 'sarankan-palet-warna':
                    displayTitle = 'Saran Palet Warna:';
                    schema = {
                        type: "OBJECT",
                        properties: {
                            color_palette: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        hex: { type: "STRING" }
                                    },
                                    required: ["name", "hex"]
                                }
                            }
                        },
                        required: ["color_palette"]
                    };
                    promptText = `Sarankan 5-7 kode warna heksadesimal yang cocok untuk palet warna berdasarkan prompt gambar berikut ini. Berikan juga nama deskriptif untuk setiap warna.
                    Prompt: ${lastEnglishPrompt}
                    Format output JSON dengan kunci 'color_palette' yang berisi array objek, setiap objek memiliki kunci 'name' dan 'hex'.`;
                    break;
                case 'sarankan-konsep-terkait':
                    displayTitle = 'Saran Konsep Terkait:';
                    promptText = `Sarankan 3-5 ide konsep atau tema baru yang terkait dengan prompt gambar berikut ini, yang bisa dikembangkan lebih lanjut. Berikan dalam format daftar.
                    Prompt: ${lastEnglishPrompt}`;
                    break;
                default:
                    newContentHtml = '<p class="text-red-400">Fitur tidak dikenal.</p>';
                    break;
            }

            const response = await callGeminiAPI(promptText, schema, 'additional'); // Specify 'additional' area for loading

            // Build the new content HTML to append
            newContentHtml += `<h4 class="text-lg font-semibold text-gray-100 mb-2">${displayTitle}</h4>`;

            if (typeof response === 'object') {
                if (feature === 'tingkatkan-prompt' && response.improved_english_prompt) {
                    newContentHtml += `<p class="mb-2"><strong>English:</strong> ${response.improved_english_prompt}</p>`;
                    newContentHtml += `<p><strong>Indonesia:</strong> ${response.improved_indonesian_prompt}</p>`;
                } else if (feature === 'hasilkan-deskripsi' && response.english_description) {
                    newContentHtml += `<p class="mb-2"><strong>English:</strong> ${response.english_description}</p>`;
                    newContentHtml += `<p><strong>Indonesia:</strong> ${response.indonesian_description}</p>`;
                } else if (feature === 'buat-variasi-prompt' && response.variations) {
                    response.variations.forEach((v, index) => {
                        newContentHtml += `<p class="mb-2"><strong>Variasi ${index + 1} (English):</strong> ${v.english_variation}</p>`;
                        newContentHtml += `<p class="mb-4"><strong>Variasi ${index + 1} (Indonesia):</strong> ${v.indonesian_variation}</p>`;
                    });
                } else if (feature === 'perbaiki-gramatika' && response.corrected_english_prompt) {
                    newContentHtml += `<p class="mb-2"><strong>English:</strong> ${response.corrected_english_prompt}</p>`;
                    newContentHtml += `<p><strong>Indonesia:</strong> ${response.corrected_indonesian_prompt}</p>`;
                } else if (feature === 'sarankan-palet-warna' && response.color_palette) {
                    response.color_palette.forEach(color => {
                        newContentHtml += `<div class="flex items-center mb-2">
                                        <div class="w-8 h-8 rounded-full mr-3" style="background-color: ${color.hex}; border: 1px solid #5a5a8a;"></div>
                                        <span>${color.name} (${color.hex})</span>
                                      </div>`;
                    });
                } else if (feature === 'sarankan-kata-kunci' && response.keywords) { // Handle keywords specifically
                    newContentHtml += `<p>${response.keywords.join(', ')}</p>`; // Join keywords with comma
                } else if (feature === 'sarankan-konsep-terkait' && Array.isArray(response)) { // Assuming concept suggestions might return an array of strings
                    newContentHtml += `<ul class="list-disc list-inside pl-4">`;
                    response.forEach(concept => {
                        newContentHtml += `<li>${concept}</li>`;
                    });
                    newContentHtml += `</ul>`;
                } else {
                    newContentHtml = `<p class="text-red-400">Error: Struktur respons tidak sesuai untuk fitur ini.</p>`;
                }
            } else if (typeof response === 'string') {
                newContentHtml += `<p>${response.replace(/\n/g, '<br>')}</p>`; // Preserve newlines for lists
            } else {
                newContentHtml = `<p class="text-red-400">${response}</p>`;
            }

            // Append the new content to the additional results area
            additionalContentDiv.innerHTML = newContentHtml; // Replace content for additional features
        }

        // Event listeners for additional feature buttons
        document.getElementById('btn-tingkatkan-prompt').addEventListener('click', () => handleAdditionalFeature('tingkatkan-prompt'));
        document.getElementById('btn-sarankan-kata-kunci').addEventListener('click', () => handleAdditionalFeature('sarankan-kata-kunci'));
        document.getElementById('btn-hasilkan-deskripsi').addEventListener('click', () => handleAdditionalFeature('hasilkan-deskripsi'));
        document.getElementById('btn-buat-variasi-prompt').addEventListener('click', () => handleAdditionalFeature('buat-variasi-prompt'));
        document.getElementById('btn-perbaiki-gramatika').addEventListener('click', () => handleAdditionalFeature('perbaiki-gramatika'));
        document.getElementById('btn-sarankan-palet-warna').addEventListener('click', () => handleAdditionalFeature('sarankan-palet-warna'));
        document.getElementById('btn-sarankan-konsep-terkait').addEventListener('click', () => handleAdditionalFeature('sarankan-konsep-terkait'));

        // Event listener for Translation Dropdown
        translationDropdown.addEventListener('change', async (event) => {
            const targetLanguageCode = event.target.value;
            let targetLanguageName = event.target.options[event.target.selectedIndex].text;

            if (!lastEnglishPrompt) {
                additionalContentDiv.innerHTML = '<p class="text-yellow-400">Silakan buat prompt utama terlebih dahulu menggunakan "Buat dengan AI" untuk menerjemahkan.</p>';
                additionalResultsArea.classList.remove('hidden');
                return;
            }

            // Clear additional results area when performing translation
            additionalContentDiv.innerHTML = '';
            additionalResultsArea.classList.remove('hidden');

            let textToTranslate = lastEnglishPrompt; // Default to English prompt for translation

            // If the current result displays an Indonesian prompt, and the user wants to translate from there
            // This logic can be expanded if users wants to translate other generated content
            if (resultDiv.innerHTML.includes(lastIndonesianPrompt) && targetLanguageCode !== 'id') {
                textToTranslate = lastIndonesianPrompt;
            }

            const promptText = `Terjemahkan teks berikut ini ke dalam bahasa ${targetLanguageName}.
            Teks: ${textToTranslate}`;

            const translatedText = await callGeminiAPI(promptText, null, 'additional'); // Specify 'additional' area for loading

            additionalContentDiv.innerHTML = `
                <h4 class="text-lg font-semibold text-gray-100 mb-2">Terjemahan (${targetLanguageName}):</h4>
                <p>${translatedText}</p>
            `;
        });

        // --- Firebase Integration for Save/Load/Delete Prompts ---

        // Function to save the current prompt
        document.getElementById('btn-simpan-prompt').addEventListener('click', async () => {
            if (!currentUserId) {
                showMessage("Anda belum terautentikasi. Silakan coba lagi.", true);
                return;
            }
            // Only allow saving if AI feature is active (i.e., isLoggedInUser is true)
            if (!isLoggedInUser) {
                showMessage("Anda perlu login untuk menyimpan prompt yang dihasilkan AI.", true);
                return;
            }
            if (!lastEnglishPrompt) {
                showMessage("Tidak ada prompt untuk disimpan. Silakan buat prompt terlebih dahulu.", true);
                return;
            }

            try {
                // Determine the type of prompt being saved
                let promptType = 'Gambar'; // Default
                const activeTabId = document.querySelector('.tab-button.active').id;
                if (activeTabId === 'tab-video-tunggal') {
                    promptType = 'Video Tunggal';
                } else if (activeTabId === 'tab-teks') {
                    promptType = 'Teks';
                } else if (activeTabId === 'tab-sutradara') {
                    promptType = 'Skenario Video';
                    // For Sutradara, lastEnglishPrompt/lastIndonesianPrompt might not be set correctly
                    // We need to capture the full generated content from resultDiv
                    // For simplicity, we'll save the raw HTML content of resultDiv for Sutradara for now.
                    // A more robust solution would parse the segments back into structured data.
                    if (resultDiv.innerHTML.includes('Skenario Video per Segmen:')) {
                        lastEnglishPrompt = resultDiv.innerText; // Capture visible text
                        lastIndonesianPrompt = resultDiv.innerText; // Assuming it's mixed or not separate
                    } else {
                        showMessage("Tidak dapat menyimpan skenario video yang tidak tergenerasi atau tidak dalam format yang diharapkan.", true);
                        return;
                    }
                }


                const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/prompts`), { // Changed path to user-specific
                    english_prompt: lastEnglishPrompt,
                    indonesian_prompt: lastIndonesianPrompt,
                    type: promptType,
                    userId: currentUserId, // Still store userId to identify owner
                    timestamp: new Date().toISOString()
                });
                showMessage("Prompt berhasil disimpan!");
                console.log("Document written with ID: ", docRef.id);
            }
            catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Error: Gagal menyimpan prompt.", true);
            }
        });

        // Function to load all saved prompts from Firestore
        async function loadGalleryPrompts() {
            if (!db || !currentUserId) { // Ensure currentUserId is available
                console.warn("Firestore atau pengguna belum terautentikasi. Tidak dapat memuat galeri.");
                galleryContentDiv.innerHTML = '<p class="text-center text-gray-500">Silakan masuk untuk melihat prompt Anda.</p>';
                showLoading(false, 'gallery');
                return;
            }
            showLoading(true, 'gallery');
            try {
                // Use onSnapshot for real-time updates
                // Query only prompts belonging to the current user
                const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/prompts`), orderBy("timestamp", "desc")); // Changed path and added filter
                onSnapshot(q, (snapshot) => {
                    galleryContentDiv.innerHTML = ''; // Clear current gallery
                    if (snapshot.empty) {
                        galleryContentDiv.innerHTML = '<p class="text-center text-gray-500">Belum ada prompt yang Anda simpan.</p>'; // Updated message
                        showLoading(false, 'gallery');
                        return;
                    }

                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const promptId = doc.id;
                        const isOwner = data.userId === currentUserId; // This check is now redundant due to path, but good for consistency
                        const timestamp = new Date(data.timestamp).toLocaleString();

                        const galleryItem = document.createElement('div');
                        galleryItem.className = 'gallery-item';
                        galleryItem.innerHTML = `
                            <div class="gallery-item-header">
                                <h5>${data.type} Prompt (${timestamp})</h5>
                                <div class="gallery-item-actions">
                                    <button class="load-btn" data-id="${promptId}" data-english="${encodeURIComponent(data.english_prompt)}" data-indonesian="${encodeURIComponent(data.indonesian_prompt)}">Muat</button>
                                    ${isOwner ? `<button class="delete-btn" data-id="${promptId}">Hapus</button>` : ''}
                                </div>
                            </div>
                            <p><strong>English:</strong> ${data.english_prompt.substring(0, 150)}...</p>
                            <p><strong>Indonesia:</strong> ${data.indonesian_prompt.substring(0, 150)}...</p>
                            <div class="meta-info">Oleh: Anda</div> <!-- Changed to 'Anda' as it's personal gallery -->
                        `;
                        galleryContentDiv.appendChild(galleryItem);
                    });

                    // Add event listeners for Load and Delete buttons in the gallery
                    galleryContentDiv.querySelectorAll('.load-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const englishPrompt = decodeURIComponent(event.target.dataset.english);
                            const indonesianPrompt = decodeURIComponent(event.target.dataset.indonesian);
                            loadPromptToMainArea(englishPrompt, indonesianPrompt);
                        });
                    });

                    galleryContentDiv.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const promptId = event.target.dataset.id;
                            deletePrompt(promptId); // Call the custom delete function
                        });
                    });
                    showLoading(false, 'gallery');
                }, (error) => { // Add error handling for onSnapshot
                    console.error("Error in gallery snapshot listener:", error);
                    showMessage("Error: Gagal memuat galeri prompt. Periksa izin akses.", true);
                    showLoading(false, 'gallery');
                });

            } catch (e) {
                console.error("Error setting up gallery listener: ", e);
                showMessage("Error: Gagal memuat galeri prompt.", true);
                showLoading(false, 'gallery');
            }
        }

        // Function to load a saved prompt into the main result area
        function loadPromptToMainArea(englishPrompt, indonesianPrompt) {
            lastEnglishPrompt = englishPrompt;
            lastIndonesianPrompt = indonesianPrompt;
            resultDiv.innerHTML = `
                <h4 class="text-lg font-semibold text-gray-100 mb-2">Prompt Bahasa Inggris:</h4>
                <p class="mb-4">${lastEnglishPrompt}</p>
                <h4 class="text-lg font-semibold text-gray-100 mb-2">Prompt Bahasa Indonesia:</h4>
                <p>${indonesianPrompt}</p>
            `;
            showMessage("Prompt berhasil dimuat ke area utama.");
            // Optionally, switch back to the Gambar tab or the relevant tab
            // For simplicity, we keep the current tab active. User can manually switch.
        }

        // Function to delete a prompt (using custom modal)
        async function deletePrompt(promptId) {
            if (!db || !currentUserId) {
                showMessage("Error: Autentikasi diperlukan untuk menghapus.", true);
                return;
            }

            // Custom confirmation logic
            const confirmDelete = await new Promise(resolve => {
                const modalHtml = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-gray-800 p-8 rounded-lg shadow-xl text-center">
                            <p class="text-lg font-semibold mb-4">Apakah Anda yakin ingin menghapus prompt ini?</p>
                            <button id="confirm-delete-yes" class="button-primary mr-4">Ya, Hapus</button>
                            <button id="confirm-delete-no" class="button-secondary">Tidak, Batalkan</button>
                        </div>
                    </div>
                `;
                const modalDiv = document.createElement('div');
                modalDiv.innerHTML = modalHtml;
                document.body.appendChild(modalDiv);

                document.getElementById('confirm-delete-yes').addEventListener('click', () => {
                    modalDiv.remove();
                    resolve(true);
                });
                document.getElementById('confirm-delete-no').addEventListener('click', () => {
                    modalDiv.remove();
                    resolve(false);
                });
            });

            if (!confirmDelete) {
                showMessage("Penghapusan dibatalkan.", false);
                return;
            }

            try {
                const promptRef = doc(db, `artifacts/${appId}/users/${currentUserId}/prompts`, promptId); // Changed path
                await deleteDoc(promptRef);
                showMessage("Prompt berhasil dihapus.");
            } catch (e) {
                console.error("Error removing document: ", e);
                showMessage("Error: Gagal menghapus prompt. Pastikan Anda adalah pemiliknya.", true);
            }
        }

    </script>
</body>
</html>
