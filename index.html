<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Prompt dengan Galeri Simpan</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --surface-color: #16213e;
            --primary-color: #0f3460;
            --secondary-color: #e94560;
            --accent-color: #53a8b6;
            --text-color: #e0e0e0;
            --label-color: #a0a0e0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            margin: auto;
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid var(--primary-color);
            position: relative;
        }
        .settings-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--label-color);
            cursor: pointer;
            padding: 5px;
        }
        .settings-btn:hover { color: #fff; }
        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 20px;
            font-size: 28px;
            text-shadow: 0 0 10px var(--secondary-color);
        }
        .tabs { display: flex; border-bottom: 2px solid var(--primary-color); margin-bottom: 20px; flex-wrap: wrap; }
        .tab-button { padding: 10px 15px; cursor: pointer; border: none; background-color: transparent; color: var(--label-color); font-size: 16px; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.3s ease; flex-grow: 1; text-align: center; }
        .tab-button.active { color: #fff; border-bottom-color: var(--secondary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        fieldset { border: 1px solid var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; position: relative; padding-top: 25px; }
        legend { padding: 0 10px; color: var(--secondary-color); font-weight: 600; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; color: var(--label-color); }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--primary-color); border-radius: 6px; color: var(--text-color); font-size: 14px; box-sizing: border-box; font-family: inherit; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .button-group { display: grid; grid-template-columns: 50px 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn { padding: 12px; font-size: 16px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-generate { background-color: var(--secondary-color); color: #fff; }
        .btn-random { background-color: var(--primary-color); color: var(--text-color); }
        .btn-reset { background-color: #334155; color: var(--text-color); padding: 10px; font-size: 20px;}
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { background-color: #475569; cursor: not-allowed; transform: none; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--secondary-color); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result-area { margin-top: 25px; background-color: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; border: 1px solid var(--primary-color); }
        .lang-selector { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 10px; }
        #prompt-output { background-color: var(--bg-color); padding: 15px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; color: #fff; font-size: 15px; line-height: 1.7; border: 1px solid #334155; }
        .result-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .result-btn { background-color: var(--primary-color); color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .result-btn.save { background-color: var(--accent-color); color: var(--bg-color); }
        .result-btn.save:disabled { background-color: #475569; cursor: not-allowed; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--surface-color); padding: 30px; border-radius: 12px; border: 1px solid var(--primary-color); width: 90%; max-width: 500px; }
        .modal-content h2 { margin-top: 0; color: var(--accent-color); }
        .modal-content p { color: var(--label-color); font-size: 14px; line-height: 1.6; }
        .modal-buttons { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        #gallery-container { display: grid; gap: 15px; grid-template-columns: 1fr; }
        .prompt-card { background-color: var(--bg-color); border: 1px solid var(--primary-color); border-radius: 8px; padding: 15px; }
        .prompt-card pre { white-space: pre-wrap; word-wrap: break-word; font-size: 14px; margin: 0 0 15px 0; }
        .prompt-card-footer { display: flex; justify-content: flex-end; gap: 10px; }
        .card-btn { border: none; background-color: #334155; color: var(--text-color); padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .card-btn.delete { background-color: var(--secondary-color); color: #fff; }
    </style>
</head>
<body>

    <div class="container">
        <button id="settings-btn" class="settings-btn" title="Pengaturan">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
        <h1>Generator Prompt AI</h1>
        <div class="tabs">
            <button class="tab-button active" data-tab="image">üé® Gambar</button>
            <button class="tab-button" data-tab="video">üé• Video</button>
            <button class="tab-button" data-tab="text">‚úçÔ∏è Teks</button>
            <button class="tab-button" data-tab="gallery">üóÉÔ∏è Galeri</button>
        </div>
        <div id="image-tab" class="tab-content active"></div>
        <div id="video-tab" class="tab-content"></div>
        <div id="text-tab" class="tab-content"></div>
        <div id="gallery-tab" class="tab-content">
            <h2 style="color:var(--accent-color); text-align:center;">Prompt Tersimpan</h2>
            <div id="gallery-container">
                <p style="text-align:center; color: var(--label-color);">Memuat prompt...</p>
            </div>
        </div>

        <div class="button-group">
            <button id="reset-btn" class="btn btn-reset" title="Bersihkan">üßπ</button>
            <button id="random-btn" class="btn btn-random">üí° Acak</button>
            <button id="generate-btn" class="btn btn-generate">üöÄ Buat dengan AI</button>
        </div>

        <div id="result-container" class="result-area" style="display: none;">
             <div class="lang-selector">
                <label for="lang-select" style="color: var(--label-color); font-size: 14px;">Bahasa Prompt:</label>
                <select id="lang-select" class="form-select" style="width: auto;">
                    <option value="id">Bahasa Indonesia</option>
                    <option value="en">English</option>
                </select>
            </div>
            <pre id="prompt-output"></pre>
            <div class="result-buttons">
                 <button id="save-btn" class="btn result-btn save">Kunci / Simpan</button>
                 <button id="copy-btn" class="btn result-btn">Salin</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Pengaturan API Key</h2>
            <p>Untuk menggunakan fitur AI, Anda perlu memasukkan Gemini API Key Anda sendiri. Anda bisa mendapatkannya secara gratis dari Google AI Studio.</p>
            <div class="form-group">
                <label for="api-key-input">Gemini API Key</label>
                <input type="password" id="api-key-input" class="form-input" placeholder="Masukkan API Key Anda di sini">
            </div>
            <div class="modal-buttons">
                <button id="cancel-settings-btn" class="btn btn-reset">Batal</button>
                <button id="save-settings-btn" class="btn btn-generate">Simpan</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', async () => {
            let db, auth, userId, firebaseReady = false, currentGeneratedPrompt = '';
            
            const userFirebaseConfig = {
                apiKey: "AIzaSyA8H2QWB4ToX3WQYrW3HjiCuMPeKlMrR74",
                authDomain: "ai-genert.firebaseapp.com",
                projectId: "ai-genert",
                storageBucket: "ai-genert.appspot.com",
                messagingSenderId: "1023520312528",
                appId: "1:1023520312528:web:d23d5f3b75553b57fde2d5",
                measurementId: "G-C69GGPVJQF"
            };
            
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
            const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-app-id';

            if (firebaseConfig && firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("PASTE_API")) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    firebaseReady = true;
                } catch (e) { console.error("Error initializing Firebase with provided config:", e); firebaseReady = false; }
            } else {
                 console.warn("Firebase config not found or is a placeholder. Gallery features will be disabled.");
                 firebaseReady = false;
            }

            if (firebaseReady) {
                onAuthStateChanged(auth, user => {
                    if (user) { userId = user.uid; listenForSavedPrompts(); } else { userId = null; }
                });
                if (!auth.currentUser) {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) { console.error("Authentication failed:", error); }
                }
            }

            const ui = {
                tabs: document.querySelectorAll('.tab-button'),
                generateBtn: document.getElementById('generate-btn'),
                randomBtn: document.getElementById('random-btn'),
                resetBtn: document.getElementById('reset-btn'),
                saveBtn: document.getElementById('save-btn'),
                copyBtn: document.getElementById('copy-btn'),
                resultContainer: document.getElementById('result-container'),
                promptOutputElem: document.getElementById('prompt-output'),
                galleryContainer: document.getElementById('gallery-container'),
                galleryTabButton: document.querySelector('.tab-button[data-tab="gallery"]'),
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'),
                saveSettingsBtn: document.getElementById('save-settings-btn'),
                cancelSettingsBtn: document.getElementById('cancel-settings-btn'),
                apiKeyInput: document.getElementById('api-key-input'),
                langSelect: document.getElementById('lang-select')
            };

            if (!firebaseReady) {
                if (ui.galleryTabButton) ui.galleryTabButton.style.display = 'none';
                if (ui.saveBtn) ui.saveBtn.disabled = true;
                const galleryTab = document.getElementById('gallery-tab');
                if(galleryTab) galleryTab.innerHTML = '<p style="text-align:center; color: var(--label-color);">Fitur galeri tidak tersedia.</p>';
            }
            
            const tStrings = {
                id: { imgTitle: "Sebuah karya seni digital", vidTitle: "Sebuah klip video sinematik", charGuide: "PANDUAN KARAKTER", sceneDesc: "DESKRIPSI ADEGAN", artDirect: "ARAHAN SENI", visualDirect: "ARAHAN VISUAL", audio: "AUDIO", desc: "Deskripsi", subject: "Subjek", action: "Aksi", setting: "Latar", lighting: "Pencahayaan", composition: "Komposisi", time: "Waktu", camera: "Camera Work", sfx: "Desain Suara/SFX", dialogueLang: "Bahasa Dialog", dialogue: "Dialog", actAs: "Berperan sebagai", about: "tentang", forAudience: "Target audiensnya adalah", useTone: "Gunakan gaya bahasa yang", formatAs: "Sajikan hasilnya dalam format" },
                en: { imgTitle: "A digital artwork", vidTitle: "A cinematic video clip", charGuide: "CHARACTER GUIDE", sceneDesc: "SCENE DESCRIPTION", artDirect: "ART DIRECTION", visualDirect: "VISUAL DIRECTION", audio: "AUDIO", desc: "Description", subject: "Subject", action: "Action", setting: "Setting", lighting: "Lighting", composition: "Composition", time: "Time", camera: "Camera Work", sfx: "Sound Design/SFX", dialogueLang: "Dialogue Language", dialogue: "Dialogue", actAs: "Act as a", about: "about", forAudience: "The target audience is", useTone: "Use a", formatAs: "Present the result in the format of" }
            };

            const randomData = {
                imgSubjects: ["ksatria naga", "penjelajah waktu", "penyihir hutan"], imgActions: ["bermeditasi di puncak gunung", "bertarung melawan monster bayangan", "merapal mantra kuno"], imgSettings: ["reruntuhan cyberpunk", "perpustakaan tak terbatas", "planet dengan flora bercahaya"], imgCharDescs: ["Pria, 40 thn, janggut tebal, mata lelah, memakai jubah penjelajah.", "Gadis muda, rambut perak, mata ungu, membawa tongkat sihir bercahaya."], imgStyles: ["Fotorealistis", "Fantasi epik", "Lukisan cat minyak"], imgLightings: ["Cahaya senja dramatis", "Malam hari dengan bulan purnama", "Neon"], imgCompositions: ["Close-up", "Wide shot", "Low-angle"],
                veoSubjects: ["A samurai warrior", "A futuristic drone", "A majestic eagle"], veoActions: ["sheathing his katana", "flying through a dense city", "soaring over a mountain range"], vidCharDescs: ["Samurai dengan armor hitam dan merah, topeng menutupi wajah.", "Drone berwarna perak dengan lampu LED biru.", "Elang dengan bulu coklat keemasan."], veoEnvironments: ["in a bamboo forest", "between towering skyscrapers", "above a snowy landscape"], veoCameras: ["slow motion", "fast-paced tracking shot", "cinematic aerial shot"], veoTimes: ["at dawn", "at night", "during a sunset"], veoLightings: ["soft morning light", "neon city lights", "dramatic backlighting"], veoStyles: ["cinematic", "anime style", "National Geographic documentary"], vidDialogueLangs: ["Jepang", "Tidak ada", "Tidak ada"], vidSfxs: ["the sound of a blade being sheathed, wind in bamboo", "humming and whirring sounds of a drone", "the cry of an eagle, wind sounds"], vidDialogues: ["", "", ""],
                textTasks: ["Tulis sebuah email", "Buat outline untuk artikel blog", "Rancang sebuah postingan media sosial"], textPersonas: ["Manajer Proyek", "Pakar Pemasaran Digital", "Seorang sejarawan"], textTopics: ["Update kemajuan proyek", "Tren SEO terbaru", "Fakta menarik tentang Kekaisaran Romawi"], textAudiences: ["Tim internal", "Pemilik bisnis kecil", "Penggemar sejarah"], textFormats: ["Tiga paragraf dengan poin-poin", "Daftar bernomor dengan penjelasan singkat", "Satu paragraf singkat dengan 3 hashtag"], textTones: ["Profesional dan informatif", "Antusias dan mudah dipahami", "Menarik dan edukatif"]
            };

            const imageTabContent = `<fieldset><legend>Inti Adegan</legend><div class="form-grid"><div class="form-group"><label for="img-subject">Subjek Utama</label><input type="text" id="img-subject" class="form-input"></div><div class="form-group"><label for="img-action">Aksi/Kegiatan</label><input type="text" id="img-action" class="form-input"></div><div class="form-group"><label for="img-setting">Latar/Setting</label><input type="text" id="img-setting" class="form-input"></div></div></fieldset><fieldset><legend>Konsistensi Karakter</legend><div class="form-group"><label for="img-char-desc">Deskripsi Detail Karakter</label><textarea id="img-char-desc" class="form-textarea" placeholder="Contoh: Pria, 30 tahun..."></textarea></div></fieldset><fieldset><legend>Arahan Seni</legend><div class="form-grid"><div class="form-group"><label for="img-style">Gaya Visual</label><input type="text" id="img-style" class="form-input"></div><div class="form-group"><label for="img-lighting">Pencahayaan</label><input type="text" id="img-lighting" class="form-input"></div><div class="form-group"><label for="img-composition">Komposisi/Angle</label><input type="text" id="img-composition" class="form-input"></div></div></fieldset>`;
            const videoTabContent = `<fieldset><span class="fieldset-status status-wajib">Wajib</span><legend>Subject & Action</legend><div class="form-grid"><div class="form-group"><label for="veo-subject">Tokoh utama</label><input type="text" id="veo-subject" class="form-input"></div><div class="form-group"><label for="veo-action">Aksi</label><input type="text" id="veo-action" class="form-input"></div></div></fieldset><fieldset><legend>Konsistensi Karakter</legend><div class="form-group"><label for="vid-char-desc">Deskripsi Detail Karakter</label><textarea id="vid-char-desc" class="form-textarea"></textarea></div></fieldset><fieldset><span class="fieldset-status status-opsional">Opsional</span><legend>Environment</legend><div class="form-group"><label for="veo-environment">Latar</label><input type="text" id="veo-environment" class="form-input"></div></fieldset><fieldset><span class="fieldset-status status-recomended">Recomended</span><legend>Camera Work</legend><div class="form-group"><label for="veo-camera">Gerakan Kamera</label><input type="text" id="veo-camera" class="form-input"></div></fieldset><fieldset><span class="fieldset-status status-opsional">Opsional</span><legend>Lighting, Time & Style</legend><div class="form-grid"><div class="form-group"><label for="veo-time">Waktu</label><input type="text" id="veo-time" class="form-input"></div><div class="form-group"><label for="veo-lighting">Pencahayaan</label><input type="text" id="veo-lighting" class="form-input"></div><div class="form-group"><label for="veo-style">Gaya</label><input type="text" id="veo-style" class="form-input"></div></div></fieldset><fieldset><legend>Audio & Dialog</legend><div class="form-grid"><div class="form-group"><label for="vid-dialogue-lang">Bahasa Dialog</label><input type="text" id="vid-dialogue-lang" class="form-input"></div><div class="form-group"><label for="vid-sfx">Desain Suara</label><input type="text" id="vid-sfx" class="form-input"></div></div><div class="form-group"><label for="vid-dialogue">Dialog</label><textarea id="vid-dialogue" class="form-textarea"></textarea></div></fieldset>`;
            const textTabContent = `<fieldset><legend>Tujuan & Persona</legend><div class="form-grid"><div class="form-group"><label for="text-task">Tugas Utama</label><input type="text" id="text-task" class="form-input"></div><div class="form-group"><label for="text-persona">Berperan Sebagai</label><input type="text" id="text-persona" class="form-input"></div></div></fieldset><fieldset><legend>Detail Konten</legend><div class="form-grid"><div class="form-group"><label for="text-topic">Topik</label><input type="text" id="text-topic" class="form-input"></div><div class="form-group"><label for="text-audience">Target Audiens</label><input type="text" id="text-audience" class="form-input"></div><div class="form-group"><label for="text-format">Format Output</label><input type="text" id="text-format" class="form-input"></div><div class="form-group"><label for="text-tone">Gaya Bahasa</label><input type="text"id="text-tone" class="form-input"></div></div></fieldset>`;
            
            document.getElementById('image-tab').innerHTML = imageTabContent;
            document.getElementById('video-tab').innerHTML = videoTabContent;
            document.getElementById('text-tab').innerHTML = textTabContent;

            const getVal = (id) => document.getElementById(id)?.value.trim() || '';
            const getActiveTabId = () => document.querySelector('.tab-button.active').dataset.tab;

            ui.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    ui.tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                });
            });

            async function callGeminiAPI(prompt) {
                const apiKey = userFirebaseConfig.apiKey; // Menggunakan kunci yang sudah di-hardcode
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text;
                    throw new Error("No response from Gemini.");
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    return `Error: ${error.message}`;
                }
            }
            
            function toggleLoading(isLoading, button) {
                if (isLoading) {
                    button.disabled = true;
                    button.dataset.originalText = button.innerHTML;
                    button.innerHTML = '<span class="loader"></span> Memproses...';
                } else {
                    button.disabled = false;
                    button.innerHTML = button.dataset.originalText;
                }
            }
            
            async function generateWithAI() {
                const button = ui.generateBtn;
                toggleLoading(true, button);
                ui.resultContainer.style.display = 'block';

                const activeTab = getActiveTabId();
                const lang = ui.langSelect.value;
                const t = tStrings[lang];
                let keywords = {};
                let promptForGemini = '';

                if (activeTab === 'image' || activeTab === 'video') {
                    const isVideo = activeTab === 'video';
                    keywords = isVideo ? { subject: getVal('veo-subject'), action: getVal('veo-action'), charDesc: getVal('vid-char-desc'), environment: getVal('veo-environment'), camera: getVal('veo-camera'), time: getVal('veo-time'), lighting: getVal('veo-lighting'), style: getVal('veo-style'), sfx: getVal('vid-sfx'), dialogueLang: getVal('vid-dialogue-lang'), dialogue: getVal('vid-dialogue') } : { subject: getVal('img-subject'), action: getVal('img-action'), setting: getVal('img-setting'), charDesc: getVal('img-char-desc'), style: getVal('img-style'), lighting: getVal('img-lighting'), composition: getVal('img-composition') };
                    promptForGemini = `Anda adalah seorang ${isVideo ? 'sutradara AI film' : 'ahli pembuat prompt gambar'}. Berdasarkan kata kunci berikut: ${JSON.stringify(keywords)}, kembangkan dan perkaya setiap elemen menjadi deskripsi yang sangat detail, imajinatif, dan sinematik dalam format terstruktur [SECTION] dalam bahasa ${lang === 'id' ? 'Indonesia' : 'English'}. Judul section juga harus dalam bahasa yang sama. Jika sebuah elemen kosong, ciptakan ide kreatif untuk mengisinya. Pastikan hasilnya kaya dengan kata sifat dan istilah teknis yang relevan.`;
                } else {
                     generateSimplePrompt();
                     toggleLoading(false, button);
                     return;
                }
                
                const enrichedPrompt = await callGeminiAPI(promptForGemini);
                
                if (enrichedPrompt && !enrichedPrompt.startsWith("Error:")) {
                    currentGeneratedPrompt = enrichedPrompt.trim();
                    ui.promptOutputElem.textContent = currentGeneratedPrompt;
                } else {
                    ui.promptOutputElem.textContent = "Gagal membuat prompt dengan AI. Periksa API Key atau coba lagi.";
                }

                toggleLoading(false, button);
            }

            function generateSimplePrompt() {
                ui.resultContainer.style.display = 'block';
                let finalPrompt = '';
                const lang = ui.langSelect.value;
                const t = tStrings[lang];
                const fields = {t: getVal('text-task'), p: getVal('text-persona'), to: getVal('text-topic'), a: getVal('text-audience'), f: getVal('text-format'), tn: getVal('text-tone')};
                let parts = [];
                if(fields.p) parts.push(`${t.actAs} ${fields.p}.`);
                if(fields.t && fields.to) parts.push(`${fields.t} ${t.about} "${fields.to}".`);
                if(fields.a) parts.push(`${t.forAudience} ${fields.a}.`);
                if(fields.tn) parts.push(`${t.useTone} ${fields.tn}.`);
                if(fields.f) parts.push(`${t.formatAs} ${fields.f}.`);
                finalPrompt = parts.join(' ');
                currentGeneratedPrompt = finalPrompt.trim();
                ui.promptOutputElem.textContent = currentGeneratedPrompt;
            }
            
            function generateRandom() {
                const activeTab = getActiveTabId();
                if (activeTab === 'image') {
                    document.getElementById('img-subject').value = getRandomItem(randomData.imgSubjects);
                    document.getElementById('img-action').value = getRandomItem(randomData.imgActions);
                    document.getElementById('img-setting').value = getRandomItem(randomData.imgSettings);
                    document.getElementById('img-char-desc').value = getRandomItem(randomData.imgCharDescs);
                    document.getElementById('img-style').value = getRandomItem(randomData.imgStyles);
                    document.getElementById('img-lighting').value = getRandomItem(randomData.imgLightings);
                    document.getElementById('img-composition').value = getRandomItem(randomData.imgCompositions);
                } else if (activeTab === 'video') {
                    const index = Math.floor(Math.random() * randomData.veoSubjects.length);
                    document.getElementById('veo-subject').value = randomData.veoSubjects[index];
                    document.getElementById('veo-action').value = randomData.veoActions[index];
                    document.getElementById('vid-char-desc').value = randomData.vidCharDescs[index];
                    document.getElementById('veo-environment').value = randomData.veoEnvironments[index];
                    document.getElementById('veo-camera').value = randomData.veoCameras[index];
                    document.getElementById('veo-time').value = randomData.veoTimes[index];
                    document.getElementById('veo-lighting').value = randomData.veoLightings[index];
                    document.getElementById('veo-style').value = randomData.veoStyles[index];
                    document.getElementById('vid-dialogue-lang').value = randomData.vidDialogueLangs[index];
                    document.getElementById('vid-sfx').value = randomData.vidSfxs[index];
                    document.getElementById('vid-dialogue').value = randomData.vidDialogues[index];
                } else {
                    document.getElementById('text-task').value = getRandomItem(randomData.textTasks);
                    document.getElementById('text-persona').value = getRandomItem(randomData.textPersonas);
                    document.getElementById('text-topic').value = getRandomItem(randomData.textTopics);
                    document.getElementById('text-audience').value = getRandomItem(randomData.textAudiences);
                    document.getElementById('text-format').value = getRandomItem(randomData.textFormats);
                    document.getElementById('text-tone').value = getRandomItem(randomData.textTones);
                }
                ui.resultContainer.style.display = 'none';
            }

            function resetForm() { 
                document.querySelectorAll('.form-input, .form-textarea').forEach(input => input.value = ''); 
                ui.resultContainer.style.display = 'none'; 
            }
            
            async function savePrompt() {
                if (!firebaseReady) { alert("Fitur penyimpanan tidak tersedia."); return; }
                if (!userId) { alert("Anda harus login untuk menyimpan prompt."); return; }
                if (!currentGeneratedPrompt) { alert("Buat prompt terlebih dahulu sebelum menyimpan."); return; }
                try {
                    const collectionPath = `artifacts/${appId}/users/${userId}/saved_prompts`;
                    await addDoc(collection(db, collectionPath), { promptText: currentGeneratedPrompt, type: getActiveTabId(), createdAt: serverTimestamp() });
                    alert("Prompt berhasil disimpan!");
                } catch (e) { console.error("Error adding document: ", e); alert("Gagal menyimpan prompt."); }
            }

            function listenForSavedPrompts() {
                if (!firebaseReady || !userId) return;
                const collectionPath = `artifacts/${appId}/users/${userId}/saved_prompts`;
                const q = query(collection(db, collectionPath), orderBy("createdAt", "desc"));
                onSnapshot(q, (querySnapshot) => {
                    const prompts = [];
                    querySnapshot.forEach((doc) => prompts.push({ id: doc.id, ...doc.data() }));
                    renderGallery(prompts);
                }, (error) => { console.error("Error listening: ", error); ui.galleryContainer.innerHTML = '<p>Gagal memuat galeri.</p>'; });
            }
            
            function renderGallery(prompts) {
                const container = ui.galleryContainer;
                if (!container) return; 
                if (prompts.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color: var(--label-color);">Anda belum menyimpan prompt apapun.</p>';
                    return;
                }
                container.innerHTML = '';
                prompts.forEach(prompt => {
                    const card = document.createElement('div');
                    card.className = 'prompt-card';
                    card.innerHTML = `<pre>${prompt.promptText}</pre><div class="prompt-card-footer"><button class="card-btn load" data-prompt='${JSON.stringify(prompt.promptText)}'>Muat</button><button class="card-btn delete" data-id="${prompt.id}">Hapus</button></div>`;
                    container.appendChild(card);
                });
            }

            async function deletePrompt(id) {
                 if (!firebaseReady || !userId) return;
                 try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/saved_prompts`, id));
                 } catch (e) { console.error("Error deleting document: ", e); alert("Gagal menghapus prompt."); }
            }
            
            if(ui.galleryContainer) {
                ui.galleryContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete')) {
                        if (confirm("Anda yakin ingin menghapus prompt ini?")) {
                            deletePrompt(e.target.dataset.id);
                        }
                    }
                    if(e.target.classList.contains('load')) {
                        const promptText = JSON.parse(e.target.dataset.prompt);
                        ui.resultContainer.style.display = 'block';
                        ui.promptOutputElem.textContent = promptText;
                        currentGeneratedPrompt = promptText;
                    }
                });
            }

            ui.generateBtn.addEventListener('click', generateWithAI);
            ui.randomBtn.addEventListener('click', generateRandom);
            ui.resetBtn.addEventListener('click', resetForm);
            ui.saveBtn.addEventListener('click', savePrompt);
            if (ui.langSelect) {
                ui.langSelect.addEventListener('change', () => {
                    if (ui.resultContainer.style.display === 'block') {
                        // Re-trigger generation if language changes
                        generateWithAI();
                    }
                });
            }

            ui.copyBtn.addEventListener('click', () => {
                if (!currentGeneratedPrompt) return;
                const textArea = document.createElement("textarea");
                textArea.value = currentGeneratedPrompt;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    ui.copyBtn.textContent = 'Tersalin!';
                    setTimeout(() => { ui.copyBtn.textContent = 'Salin'; }, 2000);
                } catch (err) { console.error('Gagal menyalin teks', err); }
                document.body.removeChild(textArea);
            });
        });
    </script>
</body>
</html>
