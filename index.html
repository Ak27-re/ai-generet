<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Prompt AI Final</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --surface-color: #16213e;
            --primary-color: #0f3460;
            --secondary-color: #e94560;
            --accent-color: #53a8b6;
            --text-color: #e0e0e0;
            --label-color: #a0a0e0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            margin: auto;
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid var(--primary-color);
            position: relative;
        }
        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 20px;
            font-size: 28px;
            text-shadow: 0 0 10px var(--secondary-color);
        }
        .tabs { display: flex; border-bottom: 2px solid var(--primary-color); margin-bottom: 20px; flex-wrap: wrap; }
        .tab-button { padding: 10px 15px; cursor: pointer; border: none; background-color: transparent; color: var(--label-color); font-size: 16px; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.3s ease; flex-grow: 1; text-align: center; }
        .tab-button.active { color: #fff; border-bottom-color: var(--secondary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        fieldset { border: 1px solid var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        legend { padding: 0 10px; color: var(--secondary-color); font-weight: 600; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; color: var(--label-color); }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--primary-color); border-radius: 6px; color: var(--text-color); font-size: 14px; box-sizing: border-box; font-family: inherit; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .button-group { display: grid; grid-template-columns: 50px 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn { padding: 12px; font-size: 16px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-ai { background-color: var(--secondary-color); color: #fff; }
        .btn-manual { background-color: var(--accent-color); color: #1a1a2e; }
        .btn-random { background-color: var(--primary-color); color: var(--text-color); }
        .btn-reset { background-color: #334155; color: var(--text-color); padding: 10px; font-size: 20px;}
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { background-color: #475569; cursor: not-allowed; transform: none; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--secondary-color); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result-area { margin-top: 25px; background-color: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; border: 1px solid var(--primary-color); }
        .lang-selector { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 10px; }
        #prompt-output { background-color: var(--bg-color); padding: 15px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; color: #fff; font-size: 15px; line-height: 1.7; border: 1px solid #334155; }
        .result-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .result-btn { background-color: var(--primary-color); color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .result-btn.save { background-color: var(--accent-color); color: var(--bg-color); }
        .result-btn.save:disabled { background-color: #475569; cursor: not-allowed; }
        #gallery-container { display: grid; gap: 15px; grid-template-columns: 1fr; }
        .prompt-card { background-color: var(--bg-color); border: 1px solid var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .prompt-card pre { white-space: pre-wrap; word-wrap: break-word; font-size: 14px; margin: 0 0 15px 0; }
        .prompt-card-footer { display: flex; justify-content: flex-end; gap: 10px; }
        .card-btn { border: none; background-color: #334155; color: var(--text-color); padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .card-btn.delete { background-color: var(--secondary-color); color: #fff; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Generator Prompt AI</h1>
        <div class="tabs">
            <button class="tab-button active" data-tab="image">üé® Gambar</button>
            <button class="tab-button" data-tab="video">üé• Video Tunggal</button>
            <button class="tab-button" data-tab="director">üé¨ Sutradara</button>
            <button class="tab-button" data-tab="text">‚úçÔ∏è Teks</button>
            <button class="tab-button" data-tab="gallery">üóÉÔ∏è Galeri</button>
        </div>
        <div id="image-tab" class="tab-content active"></div>
        <div id="video-tab" class="tab-content"></div>
        <div id="director-tab" class="tab-content"></div>
        <div id="text-tab" class="tab-content"></div>
        <div id="gallery-tab" class="tab-content">
            <h2 style="color:var(--accent-color); text-align:center;">Prompt Tersimpan</h2>
            <div id="gallery-container">
                <p style="text-align:center; color: var(--label-color);">Memuat prompt...</p>
            </div>
        </div>

        <div class="button-group">
            <button id="reset-btn" class="btn btn-reset" title="Bersihkan">üßπ</button>
            <button id="random-btn" class="btn btn-random">üí° Acak</button>
            <button id="manual-generate-btn" class="btn btn-manual">üöÄ Buat Manual</button>
            <button id="ai-generate-btn" class="btn btn-ai">‚ú® Buat dengan AI</button>
        </div>

        <div id="result-container" class="result-area" style="display: none;">
             <div class="lang-selector">
                <label for="lang-select" style="color: var(--label-color); font-size: 14px;">Bahasa Prompt:</label>
                <select id="lang-select" class="form-select" style="width: auto;">
                    <option value="id">Bahasa Indonesia</option>
                    <option value="en">English</option>
                </select>
            </div>
            <pre id="prompt-output"></pre>
            <div class="result-buttons">
                 <button id="save-btn" class="btn result-btn save">Kunci / Simpan</button>
                 <button id="copy-btn" class="btn result-btn">Salin</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const userFirebaseConfig = {
            apiKey: "AIzaSyA8H2QWB4ToX3WQYrW3HjiCuMPeKlMrR74",
            authDomain: "ai-genert.firebaseapp.com",
            projectId: "ai-genert",
            storageBucket: "ai-genert.appspot.com",
            messagingSenderId: "1023520312528",
            appId: "1:1023520312528:web:d23d5f3b75553b57fde2d5",
            measurementId: "G-C69GGPVJQF"
        };
        const GEMINI_API_KEY = userFirebaseConfig.apiKey;

        document.addEventListener('DOMContentLoaded', () => {
            const app = new PromptApp();
            app.init();
        });

        class PromptApp {
            constructor() {
                this.db = null;
                this.auth = null;
                this.userId = null;
                this.firebaseReady = false;
                this.currentGeneratedPrompt = '';
            }

            init() {
                this.initContent();
                this.initUI();
                this.initFirebase();
                this.initEventListeners();
            }

            async initFirebase() {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
                const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-app-id';
                this.appId = appId;

                if (firebaseConfig && firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("PASTE_API")) {
                    try {
                        const app = initializeApp(firebaseConfig);
                        this.db = getFirestore(app);
                        this.auth = getAuth(app);
                        this.firebaseReady = true;

                        onAuthStateChanged(this.auth, user => {
                            if (user) { 
                                this.userId = user.uid; 
                                this.listenForSavedPrompts();
                            } else { 
                                this.userId = null; 
                            }
                        });
                        
                        if (!this.auth.currentUser) {
                            await signInAnonymously(this.auth);
                        }

                    } catch (e) { console.error("Error initializing Firebase:", e); this.firebaseReady = false; }
                } else {
                     console.warn("Firebase config not found or is a placeholder. Gallery features disabled.");
                     this.firebaseReady = false;
                }
            }
            
            initContent() {
                const imageTabContent = `<fieldset><legend>Inti Adegan</legend><div class="form-grid"><div class="form-group"><label for="img-subject">Subjek Utama</label><input type="text" id="img-subject" class="form-input"></div><div class="form-group"><label for="img-action">Aksi/Kegiatan</label><input type="text" id="img-action" class="form-input"></div><div class="form-group"><label for="img-setting">Latar/Setting</label><input type="text" id="img-setting" class="form-input"></div></div></fieldset><fieldset><legend>Konsistensi Karakter</legend><div class="form-group"><label for="img-char-desc">Deskripsi Detail Karakter</label><textarea id="img-char-desc" class="form-textarea" placeholder="Contoh: Pria, 30 tahun..."></textarea></div></fieldset><fieldset><legend>Arahan Seni</legend><div class="form-grid" id="image-art-direction"></div></fieldset>`;
                const videoTabContent = `<fieldset><legend>Subject & Action</legend><div class="form-grid"><div class="form-group"><label for="veo-subject">Tokoh utama</label><input type="text" id="veo-subject" class="form-input"></div><div class="form-group"><label for="veo-action">Aksi</label><input type="text" id="veo-action" class="form-input"></div></div></fieldset><fieldset><legend>Konsistensi Karakter</legend><div class="form-group"><label for="vid-char-desc">Deskripsi Detail Karakter</label><textarea id="vid-char-desc" class="form-textarea"></textarea></div></fieldset><fieldset><legend>Environment</legend><div class="form-group"><label for="veo-environment">Latar</label><input type="text" id="veo-environment" class="form-input"></div></fieldset><fieldset><legend>Arahan Visual & Durasi</legend><div class="form-grid" id="video-visual-direction"></div></fieldset><fieldset><legend>Audio & Dialog</legend><div class="form-grid"><div class="form-group"><label for="vid-dialogue-lang">Bahasa Dialog</label><input type="text" id="vid-dialogue-lang" class="form-input"></div><div class="form-group"><label for="vid-sfx">Desain Suara</label><input type="text" id="vid-sfx" class="form-input"></div></div><div class="form-group"><label for="vid-dialogue">Dialog</label><textarea id="vid-dialogue" class="form-textarea"></textarea></div></fieldset>`;
                const directorTabContent = `<fieldset><legend>Konsep Cerita</legend><div class="form-group"><label for="dir-story">Ide Utama Cerita</label><textarea id="dir-story" class="form-textarea" placeholder="Contoh: Seorang ksatria naga menemukan pedang legendaris..."></textarea></div><div class="form-grid"><div class="form-group"><label for="dir-duration">Total Durasi Video (detik)</label><input type="number" id="dir-duration" class="form-input" min="8" value="30"></div></div></fieldset><fieldset><legend>Karakter & Konsistensi</legend><div class="form-group"><label for="dir-char">Deskripsi Detail Karakter</label><textarea id="dir-char" class="form-textarea" placeholder="Contoh: Ksatria pria, 30 tahun, rambut hitam panjang..."></textarea></div><div class="form-group"><label for="dir-consistency-key">Kata Kunci Konsistensi Karakter</label><input type="text" id="dir-consistency-key" class="form-input" placeholder="Contoh: KsatriaNagaEmas, DetektifCyberV1"></div></fieldset><fieldset><legend>Audio & Dialog</legend><div class="form-group"><label for="dir-dialogue">Naskah Percakapan (Opsional)</label><textarea id="dir-dialogue" class="form-textarea" placeholder="Ksatria: 'Aku harus mengambil pedang itu!'..."></textarea></div><div class="form-group"><label for="dir-dialogue-lang">Bahasa Dialog</label><input type="text" id="dir-dialogue-lang" class="form-input" placeholder="Indonesia, Inggris, Jawa..."></div></fieldset>`;
                const textTabContent = `<fieldset><legend>Tujuan & Persona</legend><div class="form-grid"><div class="form-group"><label for="text-task">Tugas Utama</label><input type="text" id="text-task" class="form-input"></div><div class="form-group"><label for="text-persona">Berperan Sebagai</label><input type="text" id="text-persona" class="form-input"></div></div></fieldset><fieldset><legend>Detail Konten</legend><div class="form-grid"><div class="form-group"><label for="text-topic">Topik</label><input type="text" id="text-topic" class="form-input"></div><div class="form-group"><label for="text-audience">Target Audiens</label><input type="text" id="text-audience" class="form-input"></div><div class="form-group"><label for="text-format">Format Output</label><input type="text" id="text-format" class="form-input"></div><div class="form-group"><label for="text-tone">Gaya Bahasa</label><input type="text"id="text-tone" class="form-input"></div></div></fieldset>`;
                
                document.getElementById('image-tab').innerHTML = imageTabContent;
                document.getElementById('video-tab').innerHTML = videoTabContent;
                document.getElementById('director-tab').innerHTML = directorTabContent;
                document.getElementById('text-tab').innerHTML = textTabContent;

                const cameraOptions = [{value:"",text:"-- Pilih Kamera --"},{value:"slow motion",text:"Slow Motion"},{value:"tracking shot",text:"Tracking Shot"},{value:"dolly zoom",text:"Dolly Zoom"},{value:"aerial shot",text:"Aerial Shot"},{value:"crane shot",text:"Crane Shot"},{value:"dutch angle",text:"Dutch Angle"},{value:"handheld shaky camera",text:"Handheld (Genggam)"},{value:"other",text:"Lainnya..."}];
                const timeOptions = [{value:"",text:"-- Pilih Waktu --"},{value:"golden hour",text:"Golden Hour (Senja)"},{value:"blue hour",text:"Blue Hour (Setelah Senja)"},{value:"nighttime",text:"Malam Hari"},{value:"midday",text:"Tengah Hari"},{value:"dawn",text:"Fajar"},{value:"other",text:"Lainnya..."}];
                const lightingOptions = [{value:"",text:"-- Pilih Pencahayaan --"},{value:"dramatic lighting",text:"Dramatis"},{value:"cinematic lighting",text:"Sinematik"},{value:"soft warm glow",text:"Cahaya Lembut & Hangat"},{value:"neon lights",text:"Lampu Neon"},{value:"backlighting",text:"Backlighting"},{value:"chiaroscuro",text:"Chiaroscuro (Kontras Tinggi)"},{value:"other",text:"Lainnya..."}];
                const styleOptions = [{value:"",text:"-- Pilih Gaya --"},{value:"photorealistic",text:"Fotorealistis"},{value:"cinematic",text:"Sinematik"},{value:"anime style",text:"Gaya Anime"},{value:"documentary style",text:"Gaya Dokumenter"},{value:"black and white",text:"Hitam Putih"},{value:"vintage film",text:"Film Vintage"},{value:"other",text:"Lainnya..."}];

                document.getElementById('image-art-direction').appendChild(this.createDropdown('img-style-select', 'Gaya Visual', styleOptions));
                document.getElementById('image-art-direction').appendChild(this.createDropdown('img-lighting-select', 'Pencahayaan', lightingOptions));
                document.getElementById('image-art-direction').appendChild(this.createDropdown('img-composition-select', 'Komposisi/Angle', cameraOptions));
                
                const videoVisualDirection = document.getElementById('video-visual-direction');
                videoVisualDirection.appendChild(this.createDropdown('veo-camera-select', 'Gerakan Kamera', cameraOptions));
                videoVisualDirection.appendChild(this.createDropdown('veo-time-select', 'Waktu', timeOptions));
                videoVisualDirection.appendChild(this.createDropdown('veo-lighting-select', 'Pencahayaan', lightingOptions));
                videoVisualDirection.appendChild(this.createDropdown('veo-style-select', 'Gaya', styleOptions));
                const durationGroup = document.createElement('div');
                durationGroup.className = 'form-group';
                durationGroup.innerHTML = `<label for="veo-duration">Durasi (detik)</label><input type="number" id="veo-duration" class="form-input" min="8" placeholder="min. 8">`;
                videoVisualDirection.appendChild(durationGroup);
            }
            
            initUI() {
                this.ui = {
                    tabs: document.querySelectorAll('.tab-button'),
                    aiGenerateBtn: document.getElementById('ai-generate-btn'),
                    manualGenerateBtn: document.getElementById('manual-generate-btn'),
                    randomBtn: document.getElementById('random-btn'),
                    resetBtn: document.getElementById('reset-btn'),
                    saveBtn: document.getElementById('save-btn'),
                    copyBtn: document.getElementById('copy-btn'),
                    resultContainer: document.getElementById('result-container'),
                    promptOutputElem: document.getElementById('prompt-output'),
                    galleryContainer: document.getElementById('gallery-container'),
                    galleryTabButton: document.querySelector('.tab-button[data-tab="gallery"]'),
                    langSelect: document.getElementById('lang-select')
                };

                this.tStrings = {
                    id: { imgTitle: "Sebuah karya seni digital", vidTitle: "Sebuah klip video sinematik", charGuide: "PANDUAN KARAKTER", sceneDesc: "DESKRIPSI ADEGAN", artDirect: "ARAHAN SENI", visualDirect: "ARAHAN VISUAL", audio: "AUDIO", desc: "Deskripsi", subject: "Subjek", action: "Aksi", setting: "Latar", lighting: "Pencahayaan", composition: "Komposisi", time: "Waktu", camera: "Camera Work", sfx: "Desain Suara/SFX", dialogueLang: "Bahasa Dialog", dialogue: "Dialog", actAs: "Berperan sebagai", about: "tentang", forAudience: "Target audiensnya adalah", useTone: "Gunakan gaya bahasa yang", formatAs: "Sajikan hasilnya dalam format", duration: "Durasi" },
                    en: { imgTitle: "A digital artwork", vidTitle: "A cinematic video clip", charGuide: "CHARACTER GUIDE", sceneDesc: "SCENE DESCRIPTION", artDirect: "ART DIRECTION", visualDirect: "VISUAL DIRECTION", audio: "AUDIO", desc: "Description", subject: "Subject", action: "Action", setting: "Setting", lighting: "Lighting", composition: "Composition", time: "Time", camera: "Camera Work", sfx: "Sound Design/SFX", dialogueLang: "Dialogue Language", dialogue: "Dialogue", actAs: "Act as a", about: "about", forAudience: "The target audience is", useTone: "Use a", formatAs: "Present the result in the format of", duration: "Duration" }
                };

                this.randomData = {
                    imgSubjects: ["ksatria naga", "penjelajah waktu", "penyihir hutan"], imgActions: ["bermeditasi di puncak gunung", "bertarung melawan monster bayangan", "merapal mantra kuno"], imgSettings: ["reruntuhan cyberpunk", "perpustakaan tak terbatas", "planet dengan flora bercahaya"], imgCharDescs: ["Pria, 40 thn, janggut tebal, mata lelah, memakai jubah penjelajah.", "Gadis muda, rambut perak, mata ungu, membawa tongkat sihir bercahaya."], imgStyles: this.getDropdownOptions('#img-style-select'), imgLightings: this.getDropdownOptions('#img-lighting-select'), imgCompositions: this.getDropdownOptions('#img-composition-select'),
                    veoSubjects: ["A samurai warrior", "A futuristic drone", "A majestic eagle"], veoActions: ["sheathing his katana", "flying through a dense city", "soaring over a mountain range"], vidCharDescs: ["Samurai dengan armor hitam dan merah, topeng menutupi wajah.", "Drone berwarna perak dengan lampu LED biru.", "Elang dengan bulu coklat keemasan."], veoEnvironments: ["in a bamboo forest", "between towering skyscrapers", "above a snowy landscape"], veoCameras: this.getDropdownOptions('#veo-camera-select'), veoTimes: this.getDropdownOptions('#veo-time-select'), veoLightings: this.getDropdownOptions('#veo-lighting-select'), veoStyles: this.getDropdownOptions('#veo-style-select'), vidDialogueLangs: ["Jepang", "Tidak ada", "Tidak ada"], vidSfxs: ["the sound of a blade being sheathed, wind in bamboo", "humming and whirring sounds of a drone", "the cry of an eagle, wind sounds"], vidDialogues: ["", "", ""], vidDurations: [8, 10, 12, 15],
                    stories: ["Seorang astronot terdampar di planet asing dan menemukan peradaban kuno.", "Detektif di kota cyberpunk memecahkan kasus pembunuhan yang melibatkan android.", "Kelompok petualang mencari artefak hilang di kuil dalam hutan lebat."],
                    chars: ["Astronot wanita, tangguh, dengan helm retak dan tatapan penuh harapan.", "Detektif pria sinis dengan mantel panjang dan mata cybernetic.", "Penyihir wanita elf dengan rambut perak dan jubah hijau zamrud."],
                    consistencyKeys: ["AstronotX7", "DetektifNeo", "PenyihirSylva"],
                    dialogues: ["K1: 'Kita tidak sendirian di sini.'", "K1: 'Apa petunjuk berikutnya?'\nK2: 'Semua mengarah ke menara itu.'", ""]
                };
            }

            initEventListeners() {
                this.ui.tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.ui.tabs.forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                    });
                });
                
                this.ui.aiGenerateBtn.addEventListener('click', () => this.generateWithAI());
                this.ui.manualGenerateBtn.addEventListener('click', () => this.generateManualPrompt());
                this.ui.randomBtn.addEventListener('click', () => this.generateRandom());
                this.ui.resetBtn.addEventListener('click', () => this.resetForm());
                
                if(this.ui.saveBtn) this.ui.saveBtn.addEventListener('click', () => this.savePrompt());
                if(this.ui.copyBtn) this.ui.copyBtn.addEventListener('click', () => this.copyPrompt());
                
                if(this.ui.galleryContainer) {
                    this.ui.galleryContainer.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete')) {
                            if (confirm("Anda yakin ingin menghapus prompt ini?")) {
                                this.deletePrompt(e.target.dataset.id);
                            }
                        }
                        if(e.target.classList.contains('load')) {
                            const promptText = JSON.parse(e.target.dataset.prompt);
                            this.ui.resultContainer.style.display = 'block';
                            this.ui.promptOutputElem.textContent = promptText;
                            this.currentGeneratedPrompt = promptText;
                        }
                    });
                }
            }
            
            createDropdown(id, label, options) {
                const group = document.createElement('div');
                group.className = 'form-group';
                group.innerHTML = `<label for="${id}">${label}</label>`;
                const selectEl = document.createElement('select');
                selectEl.id = id;
                selectEl.className = 'form-select';
                options.forEach(opt => {
                    selectEl.innerHTML += `<option value="${opt.value}">${opt.text}</option>`;
                });
                const otherInput = document.createElement('input');
                otherInput.type = 'text';
                otherInput.id = `${id}-other`;
                otherInput.className = 'form-input';
                otherInput.style.display = 'none';
                otherInput.style.marginTop = '5px';
                otherInput.placeholder = 'Ketik opsi lainnya...';
                
                selectEl.addEventListener('change', () => {
                    otherInput.style.display = selectEl.value === 'other' ? 'block' : 'none';
                });
                
                group.appendChild(selectEl);
                group.appendChild(otherInput);
                return group;
            }

            getDropdownOptions(selector) {
                const select = document.querySelector(selector);
                if (!select) return [];
                return Array.from(select.options).filter(o => o.value).map(o => o.value);
            }
            
            getVal(id) {
                const el = document.getElementById(id);
                if (!el) return '';
                if (el.tagName === 'SELECT') {
                    if (el.value === 'other') {
                        const otherInput = document.getElementById(`${id}-other`);
                        return otherInput ? otherInput.value.trim() : '';
                    }
                    return el.value;
                }
                return el.value.trim();
            }

            getActiveTabId() {
                return document.querySelector('.tab-button.active').dataset.tab;
            }
            
            getRandomItem(arr) {
                if (!arr || arr.length === 0) return '';
                return arr[Math.floor(Math.random() * arr.length)];
            }
            
            async callGeminiAPI(prompt, apiKey) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text;
                    throw new Error("No response from Gemini.");
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    return `Error: ${error.message}`;
                }
            }
            
            toggleLoading(isLoading, button) {
                if (isLoading) {
                    button.disabled = true;
                    button.dataset.originalText = button.innerHTML;
                    button.innerHTML = '<span class="loader"></span> Memproses...';
                } else {
                    button.disabled = false;
                    button.innerHTML = button.dataset.originalText;
                }
            }
            
            async generateWithAI() {
                const button = this.ui.aiGenerateBtn;
                this.toggleLoading(true, button);
                this.ui.resultContainer.style.display = 'block';
                this.ui.promptOutputElem.textContent = "Menghubungi AI...";

                const apiKey = GEMINI_API_KEY; 
                if (!apiKey || apiKey.includes("PASTE_API_KEY")) {
                    alert("API Key tidak valid.");
                    this.toggleLoading(false, button);
                    return;
                }

                const activeTab = this.getActiveTabId();
                const lang = this.ui.langSelect.value;
                let keywords = {};
                let promptForGemini = '';
                
                if (activeTab === 'director') {
                     keywords = { story: this.getVal('dir-story'), charDesc: this.getVal('dir-char'), consistencyKey: this.getVal('dir-consistency-key'), duration: this.getVal('dir-duration'), dialogue: this.getVal('dir-dialogue'), dialogueLang: this.getVal('dir-dialogue-lang')};
                     promptForGemini = `Anda adalah seorang sutradara film dan penulis naskah. Tugas Anda adalah membuat storyboard prompt untuk video AI. Konsep Utama: "${keywords.story}". Deskripsi Karakter Utama (Jaga konsistensinya): "${keywords.charDesc}". Kata Kunci Konsistensi (WAJIB ADA DI SETIAP PROMPT): "${keywords.consistencyKey}". Naskah Dialog: "${keywords.dialogue}". Bahasa Dialog: ${keywords.dialogueLang || 'sesuai konteks'}. Total Durasi Video yang Diinginkan: ${keywords.duration} detik. Buatlah rangkaian prompt video yang saling menyambung. Setiap prompt harus menghasilkan klip video berdurasi sekitar 4-8 detik. Jumlah prompt harus disesuaikan agar total durasi mendekati ${keywords.duration} detik. Untuk SETIAP prompt, gunakan format terstruktur berikut: **Adegan [Nomor Adegan]:** - **Prompt:** [Tulis prompt video yang sangat detail. WAJIB sertakan "${keywords.consistencyKey}" saat mendeskripsikan karakter. Jika ada dialog, deskripsikan juga gerakan bibir karakter saat berbicara.] - **Dialog:** [Bagian dialog untuk adegan ini, jika ada] - **Durasi Adegan:** [Estimasi durasi untuk prompt ini, misal: 5 detik]. Pastikan ada alur yang jelas dari awal hingga akhir dan karakter tetap konsisten.`;
                } else if (activeTab === 'image' || activeTab === 'video') {
                    const isVideo = activeTab === 'video';
                    keywords = isVideo ? { subject: this.getVal('veo-subject'), action: this.getVal('veo-action'), charDesc: this.getVal('vid-char-desc'), environment: this.getVal('veo-environment'), camera: this.getVal('veo-camera-select'), time: this.getVal('veo-time-select'), lighting: this.getVal('veo-lighting-select'), style: this.getVal('veo-style-select'), sfx: this.getVal('vid-sfx'), dialogueLang: this.getVal('vid-dialogue-lang'), dialogue: this.getVal('vid-dialogue'), duration: this.getVal('veo-duration') } : { subject: this.getVal('img-subject'), action: this.getVal('img-action'), setting: this.getVal('img-setting'), charDesc: this.getVal('img-char-desc'), style: this.getVal('img-style-select'), lighting: this.getVal('img-lighting-select'), composition: this.getVal('img-composition-select') };
                    promptForGemini = `Anda adalah seorang ${isVideo ? 'sutradara AI film' : 'ahli pembuat prompt gambar'}. Berdasarkan kata kunci berikut: ${JSON.stringify(keywords)}, kembangkan dan perkaya setiap elemen menjadi deskripsi yang sangat detail, imajinatif, dan sinematik dalam format terstruktur [SECTION] dalam bahasa ${lang === 'id' ? 'Indonesia' : 'English'}. Judul section juga harus dalam bahasa yang sama. Jika sebuah elemen kosong, ciptakan ide kreatif untuk mengisinya. Pastikan hasilnya kaya dengan kata sifat dan istilah teknis yang relevan.`;
                } else {
                     this.generateManualPrompt();
                     this.toggleLoading(false, button);
                     return;
                }
                
                const enrichedPrompt = await this.callGeminiAPI(promptForGemini, apiKey);
                
                if (enrichedPrompt && !enrichedPrompt.startsWith("Error:")) {
                    this.currentGeneratedPrompt = enrichedPrompt.trim();
                    this.ui.promptOutputElem.textContent = this.currentGeneratedPrompt;
                } else {
                    this.ui.promptOutputElem.textContent = `Gagal membuat prompt dengan AI. Periksa API Key atau coba lagi. \n\nPastikan layanan "Generative Language API" sudah aktif di Google Cloud Console.`;
                }

                this.toggleLoading(false, button);
            }
            
            generateManualPrompt() {
                this.ui.resultContainer.style.display = 'block';
                let finalPrompt = '';
                const activeTab = this.getActiveTabId();
                const lang = this.ui.langSelect.value;
                const t = this.tStrings[lang];

                const buildSection = (title, lines) => {
                    const filteredLines = lines.filter(line => line.value);
                    if (filteredLines.length === 0) return '';
                    return `[${title}]\n${filteredLines.map(line => `- ${line.label}: ${line.value}`).join('\n')}\n\n`;
                };

                if (activeTab === 'video') {
                    finalPrompt += `${t.vidTitle}, ${this.getVal('veo-style-select') || 'realistis'}.\n\n`;
                    finalPrompt += buildSection(t.charGuide, [{label: t.desc, value: this.getVal('vid-char-desc')}]);
                    finalPrompt += buildSection(t.sceneDesc, [{label: t.subject, value: this.getVal('veo-subject')}, {label: t.action, value: this.getVal('veo-action')}, {label: t.setting, value: this.getVal('veo-environment')}, {label: t.time, value: this.getVal('veo-time-select')}, {label: t.duration, value: this.getVal('veo-duration') ? `${this.getVal('veo-duration')} seconds` : ''}]);
                    finalPrompt += buildSection(t.visualDirect, [{label: t.camera, value: this.getVal('veo-camera-select')}, {label: t.lighting, value: this.getVal('veo-lighting-select')}]);
                    finalPrompt += buildSection(t.audio, [{label: t.sfx, value: this.getVal('vid-sfx')}, {label: t.dialogueLang, value: this.getVal('vid-dialogue-lang')}, {label: t.dialogue, value: this.getVal('vid-dialogue')}]);
                } else if (activeTab === 'image') {
                    finalPrompt += `${t.imgTitle}, ${this.getVal('img-style-select') || 'sangat detail'}.\n\n`;
                    finalPrompt += buildSection(t.charGuide, [{label: t.desc, value: this.getVal('img-char-desc')}]);
                    finalPrompt += buildSection(t.sceneDesc, [{label: t.subject, value: this.getVal('img-subject')}, {label: t.action, value: this.getVal('img-action')}, {label: t.setting, value: this.getVal('img-setting')}]);
                    finalPrompt += buildSection(t.artDirect, [{label: t.lighting, value: this.getVal('img-lighting-select')}, {label: t.composition, value: this.getVal('img-composition-select')}]);
                } else {
                    const fields = {t: this.getVal('text-task'), p: this.getVal('text-persona'), to: this.getVal('text-topic'), a: this.getVal('text-audience'), f: this.getVal('text-format'), tn: this.getVal('text-tone')};
                    let parts = [];
                    if(fields.p) parts.push(`${t.actAs} ${fields.p}.`);
                    if(fields.t && fields.to) parts.push(`${t.about} "${fields.to}".`);
                    if(fields.a) parts.push(`${t.forAudience} ${fields.a}.`);
                    if(fields.tn) parts.push(`${t.useTone} ${fields.tn}.`);
                    if(fields.f) parts.push(`${t.formatAs} ${fields.f}.`);
                    finalPrompt = parts.join(' ');
                }
                this.currentGeneratedPrompt = finalPrompt.trim();
                this.ui.promptOutputElem.textContent = this.currentGeneratedPrompt;
            }
            
            generateRandom() {
                const activeTab = this.getActiveTabId();
                if (activeTab === 'image') {
                    document.getElementById('img-subject').value = this.getRandomItem(this.randomData.imgSubjects);
                    document.getElementById('img-action').value = this.getRandomItem(this.randomData.imgActions);
                    document.getElementById('img-setting').value = this.getRandomItem(this.randomData.imgSettings);
                    document.getElementById('img-char-desc').value = this.getRandomItem(this.randomData.imgCharDescs);
                    document.getElementById('img-style-select').value = this.getRandomItem(this.randomData.imgStyles);
                    document.getElementById('img-lighting-select').value = this.getRandomItem(this.randomData.imgLightings);
                    document.getElementById('img-composition-select').value = this.getRandomItem(this.randomData.imgCompositions);
                } else if (activeTab === 'video') {
                    const index = Math.floor(Math.random() * this.randomData.veoSubjects.length);
                    document.getElementById('veo-subject').value = this.randomData.veoSubjects[index];
                    document.getElementById('veo-action').value = this.randomData.veoActions[index];
                    document.getElementById('vid-char-desc').value = this.randomData.vidCharDescs[index];
                    document.getElementById('veo-environment').value = this.randomData.veoEnvironments[index];
                    document.getElementById('veo-camera-select').value = this.getRandomItem(this.randomData.veoCameras);
                    document.getElementById('veo-time-select').value = this.getRandomItem(this.randomData.veoTimes);
                    document.getElementById('veo-lighting-select').value = this.getRandomItem(this.randomData.veoLightings);
                    document.getElementById('veo-style-select').value = this.getRandomItem(this.randomData.veoStyles);
                    document.getElementById('veo-duration').value = this.getRandomItem(this.randomData.vidDurations);
                    document.getElementById('vid-dialogue-lang').value = this.randomData.vidDialogueLangs[index];
                    document.getElementById('vid-sfx').value = this.randomData.vidSfxs[index];
                    document.getElementById('vid-dialogue').value = this.randomData.vidDialogues[index];
                } else if (activeTab === 'director') {
                    document.getElementById('dir-story').value = this.getRandomItem(this.randomData.stories);
                    document.getElementById('dir-char').value = this.getRandomItem(this.randomData.chars);
                    document.getElementById('dir-consistency-key').value = this.getRandomItem(this.randomData.consistencyKeys);
                    document.getElementById('dir-dialogue').value = this.getRandomItem(this.randomData.dialogues);
                    document.getElementById('dir-duration').value = 30;
                } else {
                    document.getElementById('text-task').value = this.getRandomItem(this.randomData.textTasks);
                    document.getElementById('text-persona').value = this.getRandomItem(this.randomData.textPersonas);
                    document.getElementById('text-topic').value = this.getRandomItem(this.randomData.textTopics);
                    document.getElementById('text-audience').value = this.getRandomItem(this.randomData.textAudiences);
                    document.getElementById('text-format').value = this.getRandomItem(this.randomData.textFormats);
                    document.getElementById('text-tone').value = this.getRandomItem(this.randomData.textTones);
                }
                this.generateWithAI();
            }

            resetForm() { 
                document.querySelectorAll('.form-input, .form-textarea, .form-select').forEach(input => {
                    if(input.tagName === 'SELECT') {
                        input.value = "";
                        const otherInput = document.getElementById(`${input.id}-other`);
                        if (otherInput) otherInput.style.display = 'none';
                    } else {
                        input.value = ''; 
                    }
                }); 
                this.ui.resultContainer.style.display = 'none'; 
            }
            
            async savePrompt() {
                if (!this.firebaseReady) { alert("Fitur penyimpanan tidak tersedia."); return; }
                if (!this.userId) { alert("Anda harus login untuk menyimpan prompt."); return; }
                if (!this.currentGeneratedPrompt) { alert("Buat prompt terlebih dahulu sebelum menyimpan."); return; }
                try {
                    const collectionPath = `artifacts/${this.appId}/users/${this.userId}/saved_prompts`;
                    await addDoc(collection(this.db, collectionPath), { promptText: this.currentGeneratedPrompt, type: this.getActiveTabId(), createdAt: serverTimestamp() });
                    alert("Prompt berhasil disimpan!");
                } catch (e) { console.error("Error adding document: ", e); alert("Gagal menyimpan prompt."); }
            }

            listenForSavedPrompts() {
                if (!this.firebaseReady || !this.userId) return;
                const collectionPath = `artifacts/${this.appId}/users/${this.userId}/saved_prompts`;
                const q = query(collection(this.db, collectionPath), orderBy("createdAt", "desc"));
                onSnapshot(q, (querySnapshot) => {
                    const prompts = [];
                    querySnapshot.forEach((doc) => prompts.push({ id: doc.id, ...doc.data() }));
                    this.renderGallery(prompts);
                }, (error) => { console.error("Error listening: ", error); this.ui.galleryContainer.innerHTML = '<p>Gagal memuat galeri.</p>'; });
            }
            
            renderGallery(prompts) {
                const container = this.ui.galleryContainer;
                if (!container) return; 
                if (prompts.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color: var(--label-color);">Anda belum menyimpan prompt apapun.</p>';
                    return;
                }
                container.innerHTML = '';
                prompts.forEach(prompt => {
                    const card = document.createElement('div');
                    card.className = 'prompt-card';
                    card.innerHTML = `<pre>${prompt.promptText}</pre><div class="prompt-card-footer"><button class="card-btn load" data-prompt='${JSON.stringify(prompt.promptText)}'>Muat</button><button class="card-btn delete" data-id="${prompt.id}">Hapus</button></div>`;
                    container.appendChild(card);
                });
            }

            async deletePrompt(id) {
                 if (!this.firebaseReady || !this.userId) return;
                 try {
                    await deleteDoc(doc(this.db, `artifacts/${this.appId}/users/${this.userId}/saved_prompts`, id));
                 } catch (e) { console.error("Error deleting document: ", e); alert("Gagal menghapus prompt."); }
            }
            
            copyPrompt() {
                if (!this.currentGeneratedPrompt) return;
                const textArea = document.createElement("textarea");
                textArea.value = this.currentGeneratedPrompt;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    this.ui.copyBtn.textContent = 'Tersalin!';
                    setTimeout(() => { this.ui.copyBtn.textContent = 'Salin'; }, 2000);
                } catch (err) { console.error('Gagal menyalin teks', err); }
                document.body.removeChild(textArea);
            }
        }
    </script>
</body>
</html>
